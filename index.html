<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>CENS â€“ Asistencia</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="CENS Asistencia">
<meta name="theme-color" content="#1d4ed8">
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg: #f0f4ff;
  --white: #ffffff;
  --blue: #2563eb;
  --blue-dark: #1d4ed8;
  --blue-light: #eff6ff;
  --green: #16a34a;
  --green-light: #dcfce7;
  --red: #dc2626;
  --red-light: #fee2e2;
  --yellow: #d97706;
  --yellow-light: #fef3c7;
  --gray: #64748b;
  --gray-light: #f1f5f9;
  --border: #e2e8f0;
  --text: #1e293b;
  --text2: #64748b;
  --shadow: 0 4px 24px rgba(37,99,235,0.10);
  --radius: 16px;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 15px;
}

/* â”€â”€ LOADING â”€â”€ */
#screen-loading {
  min-height: 100vh;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: linear-gradient(160deg, #1d4ed8 0%, #2563eb 60%, #3b82f6 100%);
  gap: 20px;
}
.loading-spinner {
  width: 52px; height: 52px;
  border: 4px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: white; font-size: 16px; font-weight: 600; }
.loading-sub { color: rgba(255,255,255,0.7); font-size: 13px; }

/* â”€â”€ LOGIN â”€â”€ */
#screen-inicio {
  min-height: 100vh; display: none;
  flex-direction: column;
  align-items: center; justify-content: center;
  padding: 28px 20px;
  background: linear-gradient(160deg, #1d4ed8 0%, #2563eb 40%, #3b82f6 100%);
}

.logo-wrap {
  width: 80px; height: 80px;
  background: rgba(255,255,255,0.15);
  border-radius: 24px;
  display: flex; align-items: center; justify-content: center;
  font-size: 36px; margin-bottom: 20px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
}

.inicio-title { font-size: 30px; font-weight: 800; color: white; margin-bottom: 6px; text-align: center; }
.inicio-sub { color: rgba(255,255,255,0.75); font-size: 14px; margin-bottom: 40px; text-align: center; }

.inicio-card {
  background: white; border-radius: 24px;
  padding: 28px; width: 100%; max-width: 360px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}

.field-label {
  font-size: 11px; font-weight: 700; color: var(--text2);
  text-transform: uppercase; letter-spacing: .6px;
  margin-bottom: 6px; display: block;
}

select, input[type="password"], input[type="date"], input[type="text"] {
  width: 100%; padding: 13px 14px;
  background: var(--gray-light);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text); font-family: inherit; font-size: 15px;
  outline: none; transition: border-color .2s;
  margin-bottom: 14px; appearance: none;
}
select:focus, input:focus { border-color: var(--blue); background: white; }

.btn-primary {
  width: 100%; padding: 15px;
  background: var(--blue); border: none; border-radius: 12px;
  color: white; font-family: inherit; font-size: 16px; font-weight: 700;
  cursor: pointer; transition: all .2s; letter-spacing: .3px;
}
.btn-primary:active { transform: scale(.98); background: var(--blue-dark); }
.btn-secondary {
  width: 100%; padding: 12px;
  background: transparent; border: 1.5px solid var(--border); border-radius: 12px;
  color: var(--text2); font-family: inherit; font-size: 14px; font-weight: 600;
  cursor: pointer; margin-top: 10px;
}

.error-box {
  background: var(--red-light); color: var(--red);
  padding: 10px 14px; border-radius: 8px;
  font-size: 13px; font-weight: 500;
  margin-bottom: 14px; display: none;
}

/* â”€â”€ APP â”€â”€ */
#screen-app { display: none; min-height: 100vh; flex-direction: column; }

.topbar {
  background: var(--blue); padding: 14px 18px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 50;
}
.topbar-left { display: flex; align-items: center; gap: 10px; }
.topbar-avatar {
  width: 38px; height: 38px;
  background: rgba(255,255,255,0.2); border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; font-weight: 700; color: white;
}
.topbar-name { font-weight: 700; color: white; font-size: 15px; }
.topbar-role { font-size: 11px; color: rgba(255,255,255,0.7); }
.topbar-logout {
  background: rgba(255,255,255,0.15); border: none;
  color: white; padding: 7px 14px; border-radius: 8px;
  font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer;
}

.main-content { flex: 1; padding: 20px 16px; max-width: 500px; margin: 0 auto; width: 100%; }

.tabs {
  display: flex; gap: 6px; margin-bottom: 24px;
  overflow-x: auto; scrollbar-width: none; padding-bottom: 2px;
}
.tabs::-webkit-scrollbar { display: none; }

@media (min-width: 600px) {
  .tabs {
    flex-wrap: wrap;
    overflow-x: visible;
  }
  .tab-btn {
    flex: 1 1 auto;
    text-align: center;
  }
  .main-content {
    max-width: 700px !important;
    padding: 28px 28px !important;
  }
  .card {
    padding: 20px 24px !important;
  }
  .stats-row {
    gap: 12px !important;
  }
  #screen-bienvenida .bienvenida-btns {
    gap: 20px !important;
  }
}
.tab-btn {
  flex-shrink: 0; padding: 9px 18px;
  border-radius: 99px; border: 1.5px solid var(--border);
  background: white; color: var(--text2);
  font-family: inherit; font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .2s; white-space: nowrap;
}
.tab-btn.active { background: var(--blue); border-color: var(--blue); color: white; }

.card {
  background: white; border-radius: var(--radius);
  padding: 18px; margin-bottom: 14px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(37,99,235,0.06);
}

.section-title { font-size: 21px; font-weight: 800; margin-bottom: 4px; }
.section-sub { color: var(--text2); font-size: 13px; margin-bottom: 20px; }

.alumno-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 0; border-bottom: 1px solid var(--border);
}
.alumno-item:last-child { border-bottom: none; }
.alumno-name { font-weight: 600; font-size: 14px; }
.alumno-num { font-size: 11px; color: var(--text2); font-family: 'JetBrains Mono', monospace; margin-top: 1px; }

.estado-btns { display: flex; gap: 5px; }
.est-btn {
  width: 36px; height: 36px; border-radius: 10px;
  border: 1.5px solid var(--border); background: var(--gray-light);
  font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all .15s;
}
.est-btn.p-active { background: var(--green-light); border-color: var(--green); }
.est-btn.a-active { background: var(--red-light); border-color: var(--red); }
.est-btn.t-active { background: var(--yellow-light); border-color: var(--yellow); }

.stats-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 16px; }
.stat-card { background: white; border-radius: 12px; padding: 12px; text-align: center; border: 1.5px solid var(--border); }
.stat-num { font-size: 24px; font-weight: 800; }
.stat-lbl { font-size: 11px; color: var(--text2); font-weight: 600; margin-top: 2px; }
.stat-card.s-green .stat-num { color: var(--green); }
.stat-card.s-red .stat-num { color: var(--red); }
.stat-card.s-yellow .stat-num { color: var(--yellow); }

.chip { display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 99px; font-size: 11px; font-weight: 700; }
.chip-p { background: var(--green-light); color: var(--green); }
.chip-a { background: var(--red-light); color: var(--red); }
.chip-t { background: var(--yellow-light); color: var(--yellow); }
.chip-n { background: var(--gray-light); color: var(--text2); }

.hist-card {
  background: white; border-radius: 14px; padding: 16px;
  margin-bottom: 12px; border: 1px solid var(--border);
  cursor: pointer; transition: border-color .2s;
}
.hist-card:hover { border-color: var(--blue); }
.hist-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.hist-curso { font-weight: 700; font-size: 15px; }
.hist-fecha { font-size: 12px; color: var(--text2); margin-top: 2px; }
.progress-bar { height: 6px; background: var(--gray-light); border-radius: 99px; overflow: hidden; margin-top: 8px; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--green), #22c55e); border-radius: 99px; }

.dir-card {
  background: white; border-radius: 14px; padding: 16px;
  margin-bottom: 10px; border: 1px solid var(--border);
  cursor: pointer; transition: border-color .2s;
}
.dir-card:hover { border-color: var(--blue); }
.dir-card-top { display: flex; justify-content: space-between; align-items: center; }
.dir-curso { font-weight: 700; }
.dir-preceptor { font-size: 12px; color: var(--text2); margin-top: 2px; }
.badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 700; }
.badge-ok { background: var(--green-light); color: var(--green); }
.badge-warn { background: var(--yellow-light); color: var(--yellow); }
.badge-none { background: var(--gray-light); color: var(--text2); }

.modal-bg {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.5); z-index: 200;
  align-items: flex-end;
}
.modal-bg.open { display: flex; }
.modal-sheet {
  background: white; border-radius: 24px 24px 0 0;
  width: 100%; max-height: 80vh; overflow-y: auto;
  padding: 20px 20px 32px;
}
.modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 99px; margin: 0 auto 18px; }
.modal-title { font-size: 18px; font-weight: 800; margin-bottom: 2px; }
.modal-sub { font-size: 13px; color: var(--text2); margin-bottom: 18px; }
.modal-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px;
}
.modal-row:last-child { border-bottom: none; }

.saving-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(37,99,235,0.85); z-index: 300;
  align-items: center; justify-content: center;
  flex-direction: column; gap: 16px;
}
.saving-overlay.show { display: flex; }
.saving-spinner { width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin .8s linear infinite; }
.saving-text { color: white; font-size: 16px; font-weight: 700; }

.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: var(--text); color: white;
  padding: 12px 22px; border-radius: 12px;
  font-weight: 600; font-size: 14px;
  opacity: 0; transition: all .3s; z-index: 400;
  pointer-events: none; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.toast.success { background: var(--green); }
.toast.error { background: var(--red); }

.empty { text-align: center; padding: 48px 20px; color: var(--text2); }
.empty-icon { font-size: 44px; margin-bottom: 12px; }
.empty-txt { font-size: 14px; }

.refresh-btn {
  width: 100%; padding: 12px;
  background: #6366f1; border: none; border-radius: 12px;
  color: white; font-family: inherit; font-size: 14px; font-weight: 600;
  cursor: pointer; margin-bottom: 16px;
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="screen-loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">CENS Asistencia</div>
  <div class="loading-sub">Cargando datos...</div>
</div>

<!-- BIENVENIDA -->
<div id="screen-bienvenida" style="display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:28px 20px;background:linear-gradient(160deg,#0f172a 0%,#1d4ed8 50%,#3b82f6 100%);position:relative;overflow:hidden">
  <!-- CÃ­rculos decorativos -->
  <div style="position:absolute;top:-60px;right:-60px;width:220px;height:220px;background:rgba(255,255,255,0.05);border-radius:50%"></div>
  <div style="position:absolute;bottom:-80px;left:-40px;width:280px;height:280px;background:rgba(255,255,255,0.04);border-radius:50%"></div>
  <div style="position:absolute;top:40%;left:-30px;width:120px;height:120px;background:rgba(255,255,255,0.06);border-radius:50%"></div>

  <div style="position:relative;z-index:1;width:100%;max-width:360px;text-align:center">
    <!-- Logo animado -->
    <div style="width:90px;height:90px;background:rgba(255,255,255,0.15);border-radius:28px;display:flex;align-items:center;justify-content:center;font-size:42px;margin:0 auto 20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.25);box-shadow:0 8px 32px rgba(0,0,0,0.2)">ğŸ«</div>

    <div style="font-size:32px;font-weight:800;color:white;margin-bottom:6px;letter-spacing:-.5px">CENS Asistencia</div>
    <div style="color:rgba(255,255,255,0.65);font-size:14px;margin-bottom:8px">Sistema de gestiÃ³n digital</div>

    <!-- LÃ­nea divisoria decorativa -->
    <div style="display:flex;align-items:center;gap:12px;margin:20px 0">
      <div style="flex:1;height:1px;background:rgba(255,255,255,0.2)"></div>
      <div style="color:rgba(255,255,255,0.5);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px">SeleccionÃ¡ tu rol</div>
      <div style="flex:1;height:1px;background:rgba(255,255,255,0.2)"></div>
    </div>

    <!-- Botones de rol -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px">
      <button onclick="elegirRol('preceptor')" style="background:white;border:none;border-radius:18px;padding:22px 10px;cursor:pointer;font-family:inherit;transition:all .2s;box-shadow:0 4px 20px rgba(0,0,0,0.15)" onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:34px;margin-bottom:8px">ğŸ‘¤</div>
        <div style="font-weight:800;color:#1e293b;font-size:15px">Preceptor/a</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;font-weight:500">Registrar asistencia</div>
      </button>
      <button onclick="elegirRol('directora')" style="background:white;border:none;border-radius:18px;padding:22px 10px;cursor:pointer;font-family:inherit;transition:all .2s;box-shadow:0 4px 20px rgba(0,0,0,0.15)" onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:34px;margin-bottom:8px">ğŸ‘©â€ğŸ’¼</div>
        <div style="font-weight:800;color:#1e293b;font-size:15px">Directora</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;font-weight:500">Panel de control</div>
      </button>
      <button onclick="entrarComoProfesor()" style="background:white;border:none;border-radius:18px;padding:22px 10px;cursor:pointer;font-family:inherit;transition:all .2s;box-shadow:0 4px 20px rgba(0,0,0,0.15);grid-column:1/-1" onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:34px;margin-bottom:8px">ğŸ‘¨â€ğŸ«</div>
        <div style="font-weight:800;color:#1e293b;font-size:15px">Profesor/a</div>
        <div style="font-size:11px;color:#64748b;margin-top:4px;font-weight:500">Ver asistencia</div>
      </button>
    </div>

    <!-- Features -->
    <div style="background:rgba(255,255,255,0.08);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.12);backdrop-filter:blur(10px)">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
        <div style="text-align:center">
          <div style="font-size:20px;margin-bottom:4px">ğŸ“Š</div>
          <div style="font-size:10px;color:rgba(255,255,255,0.7);font-weight:600">Tiempo real</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:20px;margin-bottom:4px">â˜ï¸</div>
          <div style="font-size:10px;color:rgba(255,255,255,0.7);font-weight:600">Google Sheets</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:20px;margin-bottom:4px">ğŸ“„</div>
          <div style="font-size:10px;color:rgba(255,255,255,0.7);font-weight:600">PDF instantÃ¡neo</div>
        </div>
      </div>
    </div>

    <div style="margin-top:20px;color:rgba(255,255,255,0.35);font-size:11px">VersiÃ³n 2.0 Â· Sincronizado con Google Sheets</div>
  </div>
</div>

<!-- LOGIN -->
<div id="screen-inicio" style="display:none">
  <div class="logo-wrap">ğŸ«</div>
  <div class="inicio-title" id="login-title">â€”</div>
  <div class="inicio-sub" id="login-sub">IngresÃ¡ tu contraseÃ±a</div>
  <div class="inicio-card">
    <div id="campo-preceptor" style="display:none">
      <label class="field-label">Tu nombre</label>
      <select id="sel-usuario" style="margin-bottom:14px">
        <option value="">SeleccionÃ¡...</option>
      </select>
    </div>
    <label class="field-label">ContraseÃ±a</label>
    <input type="password" id="inp-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')login()">
    <div class="error-box" id="login-error">ContraseÃ±a incorrecta</div>
    <button class="btn-primary" onclick="login()">Ingresar â†’</button>
    <button class="btn-secondary" onclick="volverBienvenida()">â† Volver</button>
  </div>
</div>

<!-- APP -->
<div id="screen-app" style="display:none">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-avatar" id="tb-avatar">?</div>
      <div>
        <div class="topbar-name" id="tb-name">â€”</div>
        <div class="topbar-role" id="tb-role">â€”</div>
      </div>
    </div>
    <button class="topbar-logout" onclick="logout()">Salir</button>
  </div>

  <!-- PRECEPTOR -->
  <div class="main-content" id="view-preceptor" style="display:none">
    <div class="tabs">
      <button class="tab-btn active" onclick="pTab('lista',this)">ğŸ“‹ Tomar lista</button>
      <button class="tab-btn" onclick="pTab('historial',this)">ğŸ“Š Historial</button>
      <button class="tab-btn" onclick="pTab('informe',this)">ğŸ“„ Informe</button>
      <button class="tab-btn" onclick="pTab('fechas',this)">ğŸ“… Por fechas</button>
      <button class="tab-btn" onclick="pTab('progresar',this)">ğŸ“ Progresar</button>
      <button class="tab-btn" onclick="pTab('salida',this)">ğŸšŒ Salida</button>
    </div>

    <div id="ptab-lista">
      <div class="section-title">Tomar lista</div>
      <div class="section-sub" id="p-curso-sub">â€”</div>

      <div class="card">
        <label class="field-label">Curso</label>
        <select id="sel-curso" onchange="renderLista()" style="margin-bottom:10px"></select>
        <label class="field-label">Fecha</label>
        <input type="date" id="inp-fecha" onchange="renderLista(); verificarHoraLimite();">
        <div id="aviso-hora" style="display:none;border-radius:10px;padding:10px 14px;margin-top:8px;font-size:13px;font-weight:600;text-align:center"></div>
      </div>

      <div id="lista-wrap" style="display:none">
        <div class="stats-row">
          <div class="stat-card s-green"><div class="stat-num" id="cnt-p">0</div><div class="stat-lbl">Presentes</div></div>
          <div class="stat-card s-red"><div class="stat-num" id="cnt-a">0</div><div class="stat-lbl">Ausentes</div></div>
          <div class="stat-card s-yellow"><div class="stat-num" id="cnt-t">0</div><div class="stat-lbl">Tardanzas</div></div>
        </div>
        <div class="card" id="lista-alumnos"></div>
        <button class="btn-primary" style="margin-top:4px" id="btn-guardar-lista" onclick="guardarLista()">ğŸ’¾ Guardar y enviar lista</button>
        <div id="lista-bloqueada" style="display:none;background:#fef2f2;border:1px solid #fca5a5;border-radius:10px;padding:10px 14px;margin-top:8px;font-size:13px;color:#dc2626;font-weight:600;text-align:center">
          ğŸ”’ Lista cerrada Â· No se puede modificar despuÃ©s de las 20:00hs
        </div>
        <button class="btn-primary" style="margin-top:10px;background:#6366f1" onclick="generarPDF()">ğŸ“„ Descargar PDF de la lista</button>
      </div>
    </div>

    <div id="ptab-historial" style="display:none">
      <div class="section-title">Mi historial</div>
      <div class="section-sub">Listas guardadas por vos</div>
      <div id="historial-list"></div>
    </div>

    <!-- TAB INFORME PRECEPTOR -->
    <div id="ptab-informe" style="display:none">
      <div class="section-title">Informe por alumno</div>
      <div class="section-sub">Resumen cuatrimestral de asistencia</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="inf-p-curso" onchange="poblarAlumnosInforme('p')" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">Alumno</label>
        <select id="inf-p-alumno" style="margin-bottom:14px">
          <option value="">Primero elegÃ­ el curso...</option>
        </select>
        <label class="field-label">PerÃ­odo</label>
        <select id="inf-p-periodo" style="margin-bottom:14px">
          <option value="1">1Â° Cuatrimestre (Marzo â€“ Junio)</option>
          <option value="2">2Â° Cuatrimestre (Julio â€“ Noviembre)</option>
          <option value="anual">Anual (Marzo â€“ Noviembre)</option>
        </select>
        <button class="btn-primary" onclick="generarInformeAlumno('p')">ğŸ“„ Generar informe PDF</button>
      </div>
    </div>

    <!-- TAB FECHAS PRECEPTOR -->
    <div id="ptab-fechas" style="display:none">
      <div class="section-title">Informe por fechas</div>
      <div class="section-sub">ConsultÃ¡ la asistencia de un alumno en un rango de dÃ­as</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="fec-p-curso" onchange="poblarAlumnosFechas('p')" style="margin-bottom:14px"><option value="">SeleccionÃ¡ un curso...</option></select>
        <label class="field-label">Alumno</label>
        <select id="fec-p-alumno" style="margin-bottom:14px"><option value="">Primero elegÃ­ el curso...</option></select>
        <label class="field-label">Desde</label>
        <input type="date" id="fec-p-desde" style="margin-bottom:14px">
        <label class="field-label">Hasta</label>
        <input type="date" id="fec-p-hasta" style="margin-bottom:14px">
        <button class="btn-primary" onclick="generarInformeFechas('p')">ğŸ“„ Generar informe PDF</button>
      </div>
    </div>

    <!-- TAB PROGRESAR PRECEPTOR -->
    <div id="ptab-progresar" style="display:none">
      <div class="section-title">Plan Progresar</div>
      <div class="section-sub">RegistrÃ¡ los alumnos anotados en el programa</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="pro-p-curso" onchange="renderAlumnosProgresar()" style="margin-bottom:4px"><option value="">SeleccionÃ¡ un curso...</option></select>
      </div>
      <div id="pro-alumnos-wrap" style="display:none">
        <div class="card">
          <div style="font-size:13px;color:var(--text2);margin-bottom:12px">TildÃ¡ los alumnos <strong>anotados en Progresar</strong></div>
          <div id="pro-alumnos-list"></div>
          <div style="display:flex;gap:8px;margin-top:14px">
            <button class="btn-primary" style="flex:1;background:#16a34a" onclick="seleccionarTodosProgresar(true)">âœ“ Todos</button>
            <button class="btn-primary" style="flex:1;background:#dc2626" onclick="seleccionarTodosProgresar(false)">âœ— Ninguno</button>
          </div>
        </div>
        <div class="stats-row">
          <div class="stat-card s-green"><div class="stat-num" id="pro-cnt-si">0</div><div class="stat-lbl">Anotados</div></div>
          <div class="stat-card s-red"><div class="stat-num" id="pro-cnt-no">0</div><div class="stat-lbl">No anotados</div></div>
          <div class="stat-card"><div class="stat-num" id="pro-cnt-tot">0</div><div class="stat-lbl">Total</div></div>
        </div>
        <button class="btn-primary" style="background:#7c3aed" onclick="guardarYExportarProgresar()">ğŸ’¾ Guardar y exportar PDF</button>
      </div>
    </div>

    <!-- TAB SALIDA EDUCATIVA -->
    <div id="ptab-salida" style="display:none">
      <div class="section-title">Salida educativa</div>
      <div class="section-sub">GenerÃ¡ el listado de alumnos que participan</div>
      <div class="card">
        <label class="field-label">Nombre de la salida / destino</label>
        <input type="text" id="sal-destino" placeholder="Ej: Visita al Museo de Ciencias...">
        <label class="field-label">Fecha de la salida</label>
        <input type="date" id="sal-fecha">
        <label class="field-label">Curso</label>
        <select id="sal-curso" onchange="renderAlumnosSalida()" style="margin-bottom:4px"><option value="">SeleccionÃ¡ un curso...</option></select>
      </div>
      <div id="sal-alumnos-wrap" style="display:none">
        <div class="card">
          <div style="font-size:13px;color:var(--text2);margin-bottom:12px">TildÃ¡ los alumnos que <strong>confirman asistencia</strong></div>
          <div id="sal-alumnos-list"></div>
          <div style="display:flex;gap:8px;margin-top:14px">
            <button class="btn-primary" style="flex:1;background:#16a34a" onclick="seleccionarTodosSalida(true)">âœ“ Todos</button>
            <button class="btn-primary" style="flex:1;background:#dc2626" onclick="seleccionarTodosSalida(false)">âœ— Ninguno</button>
          </div>
        </div>
        <div class="stats-row">
          <div class="stat-card s-green"><div class="stat-num" id="sal-cnt-si">0</div><div class="stat-lbl">Confirman</div></div>
          <div class="stat-card s-red"><div class="stat-num" id="sal-cnt-no">0</div><div class="stat-lbl">No van</div></div>
          <div class="stat-card"><div class="stat-num" id="sal-cnt-tot">0</div><div class="stat-lbl">Total</div></div>
        </div>
        <button class="btn-primary" onclick="generarPDFSalida()">ğŸ“„ Generar listado PDF</button>
      </div>
    </div>
  </div>

  <!-- DIRECTORA -->
  <div class="main-content" id="view-directora" style="display:none">
    <div class="tabs">
      <button class="tab-btn active" onclick="dTab('resumen',this)">ğŸ“Š Resumen</button>
      <button class="tab-btn" onclick="dTab('buscar',this)">ğŸ” Buscar</button>
      <button class="tab-btn" onclick="dTab('informe',this)">ğŸ“„ Informe</button>
      <button class="tab-btn" onclick="dTab('fechas',this)">ğŸ“… Por fechas</button>
      <button class="tab-btn" onclick="dTab('progresar',this)">ğŸ“ Progresar</button>
      <button class="tab-btn" onclick="dTab('exportar',this)">ğŸ“¥ Exportar</button>
    </div>

    <div id="dtab-resumen">
      <div class="section-title">Panel general</div>
      <div class="section-sub" id="dir-fecha-lbl">â€”</div>
      <div class="stats-row">
        <div class="stat-card s-green"><div class="stat-num" id="dir-p">â€”</div><div class="stat-lbl">Presentes hoy</div></div>
        <div class="stat-card s-red"><div class="stat-num" id="dir-a">â€”</div><div class="stat-lbl">Ausentes hoy</div></div>
        <div class="stat-card"><div class="stat-num" id="dir-cursos">â€”</div><div class="stat-lbl">Cursos con lista</div></div>
      </div>
      <button class="refresh-btn" onclick="cargarRegistrosYResumen()">ğŸ”„ Actualizar datos</button>
      <button class="refresh-btn" style="background:#6366f1;margin-bottom:16px" onclick="generarPDFResumen()">ğŸ“„ Descargar PDF resumen</button>
      <div id="dir-cursos-list"></div>
    </div>

    <div id="dtab-buscar" style="display:none">
      <div class="section-title">Buscar</div>
      <div class="section-sub">FiltrÃ¡ por fecha o alumno</div>
      <input type="date" id="buscar-fecha" oninput="filtrar()">
      <input type="text" id="buscar-nombre" placeholder="ğŸ” Nombre del alumno..." oninput="filtrar()">
      <div id="buscar-results"></div>
    </div>

    <!-- TAB INFORME DIRECTORA -->
    <div id="dtab-informe" style="display:none">
      <div class="section-title">Informe por alumno</div>
      <div class="section-sub">Resumen cuatrimestral de asistencia</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="inf-d-curso" onchange="poblarAlumnosInforme('d')" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">Alumno</label>
        <select id="inf-d-alumno" style="margin-bottom:14px">
          <option value="">Primero elegÃ­ el curso...</option>
        </select>
        <label class="field-label">PerÃ­odo</label>
        <select id="inf-d-periodo" style="margin-bottom:14px">
          <option value="1">1Â° Cuatrimestre (Marzo â€“ Junio)</option>
          <option value="2">2Â° Cuatrimestre (Julio â€“ Noviembre)</option>
          <option value="anual">Anual (Marzo â€“ Noviembre)</option>
        </select>
        <button class="btn-primary" onclick="generarInformeAlumno('d')">ğŸ“„ Generar informe PDF</button>
      </div>
    </div>

    <!-- TAB FECHAS DIRECTORA -->
    <div id="dtab-fechas" style="display:none">
      <div class="section-title">Informe por fechas</div>
      <div class="section-sub">ConsultÃ¡ la asistencia de un alumno en un rango de dÃ­as</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="fec-d-curso" onchange="poblarAlumnosFechas('d')" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">Alumno</label>
        <select id="fec-d-alumno" style="margin-bottom:14px">
          <option value="">Primero elegÃ­ el curso...</option>
        </select>
        <label class="field-label">Desde</label>
        <input type="date" id="fec-d-desde" style="margin-bottom:14px">
        <label class="field-label">Hasta</label>
        <input type="date" id="fec-d-hasta" style="margin-bottom:14px">
        <button class="btn-primary" onclick="generarInformeFechas('d')">ğŸ“„ Generar informe PDF</button>
      </div>
    </div>

    <!-- TAB PROGRESAR DIRECTORA -->
    <div id="dtab-progresar" style="display:none">
      <div class="section-title">Seguimiento Plan Progresar</div>
      <div class="section-sub">Alumnos anotados por curso</div>
      <button class="refresh-btn" onclick="cargarProgresar()">ğŸ”„ Actualizar datos</button>
      <button class="refresh-btn" style="background:#7c3aed;margin-bottom:16px" onclick="generarPDFProgresar()">ğŸ“„ Descargar PDF Progresar</button>
      <div id="pro-resumen-dir"></div>
    </div>

    <!-- TAB EXPORTAR -->
    <div id="dtab-exportar" style="display:none">
      <div class="section-title">Exportar datos</div>
      <div class="section-sub">DescargÃ¡ informes en Excel (.xlsx)</div>
      <div class="card">
        <div style="font-weight:700;color:var(--text1);margin-bottom:6px">ğŸ“‹ Salidas Educativas</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Todas las salidas registradas con detalle de alumnos confirmados</div>
        <button class="btn-primary" style="background:#16a34a;width:100%" onclick="exportarSalidasExcel()">ğŸ“¥ Descargar Excel</button>
      </div>
      <div class="card">
        <div style="font-weight:700;color:var(--text1);margin-bottom:6px">ğŸ“ Plan Progresar</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Todos los alumnos anotados en Progresar por curso</div>
        <button class="btn-primary" style="background:#7c3aed;width:100%" onclick="exportarProgresarExcel()">ğŸ“¥ Descargar Excel</button>
      </div>
      <div class="card">
        <div style="font-weight:700;color:var(--text1);margin-bottom:6px">ğŸ“Š Asistencia completa</div>
        <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Todos los registros del aÃ±o â€” una hoja por curso</div>
        <button class="btn-primary" style="width:100%" onclick="exportarAsistenciaExcel()">ğŸ“¥ Descargar Excel</button>
      </div>
    </div>
  </div>
</div>


<!-- PROFESOR -->
<div class="main-content" id="view-profesor" style="display:none;padding:0;max-width:100%">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="tb-avatar" style="background:#0d9488">ğŸ‘¨â€ğŸ«</div>
      <div>
        <div class="tb-name">Profesor/a</div>
        <div class="tb-rol">Solo visualizaciÃ³n</div>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">Salir</button>
  </div>

  <div style="max-width:500px;margin:0 auto;padding:0 16px">
    <div class="tabs" style="margin-top:16px">
      <button class="tab-btn active" onclick="profTab('historial',this)">ğŸ“‹ Historial</button>
      <button class="tab-btn" onclick="profTab('resumen',this)">ğŸ“Š Resumen curso</button>
      <button class="tab-btn" onclick="profTab('cuatrimestral',this)">ğŸ“„ Cuatrimestral</button>
      <button class="tab-btn" onclick="profTab('anual',this)">ğŸ“… Anual</button>
      <button class="tab-btn" onclick="profTab('fechas',this)">ğŸ” Por fechas</button>
    </div>

    <!-- TAB HISTORIAL (primero y activo por defecto) -->
    <div id="proftab-historial">
      <div class="section-title">Historial por dÃ­a</div>
      <div class="section-sub">Ver la asistencia de un curso en una fecha</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="prof-his-curso" onchange="renderHistorialDiaProfesor()" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">Fecha</label>
        <input type="date" id="prof-his-fecha" onchange="renderHistorialDiaProfesor()" style="margin-bottom:4px">
      </div>
      <div id="prof-his-lista"></div>
    </div>

    <!-- TAB RESUMEN CURSO -->
    <div id="proftab-resumen" style="display:none">
      <div class="section-title">Resumen del curso</div>
      <div class="section-sub">Totales de asistencia por alumno</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="prof-res-curso" onchange="renderResumenCursoProfesor()" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">PerÃ­odo</label>
        <select id="prof-res-periodo" onchange="renderResumenCursoProfesor()" style="margin-bottom:4px">
          <option value="1">1Â° Cuatrimestre (Marzo â€“ Junio)</option>
          <option value="2">2Â° Cuatrimestre (Julio â€“ Noviembre)</option>
          <option value="anual">Anual (Marzo â€“ Noviembre)</option>
        </select>
      </div>
      <div id="prof-res-lista"></div>
      <div id="prof-res-btn" style="display:none">
        <button class="btn-primary" style="background:#0d9488" onclick="generarPDFResumenCurso()">ğŸ“„ Descargar PDF resumen</button>
      </div>
    </div>

    <!-- TAB CUATRIMESTRAL -->
    <div id="proftab-cuatrimestral" style="display:none">
      <div class="section-title">Informe cuatrimestral</div>
      <div class="section-sub">SeleccionÃ¡ el curso y el perÃ­odo</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="prof-inf-curso" onchange="poblarAlumnosProfesor('inf')" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">Cuatrimestre</label>
        <select id="prof-inf-periodo" style="margin-bottom:14px">
          <option value="1">1Â° Cuatrimestre (Marzo â€“ Junio)</option>
          <option value="2">2Â° Cuatrimestre (Julio â€“ Noviembre)</option>
          <option value="anual">Anual (Marzo â€“ Noviembre)</option>
        </select>
        <label class="field-label">Alumno</label>
        <select id="prof-inf-alumno" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un alumno...</option>
        </select>
        <button class="btn-primary" onclick="generarInformeProfesor('cuatrimestral')">ğŸ“„ Generar informe PDF</button>
      </div>
    </div>

    <!-- TAB ANUAL -->
    <div id="proftab-anual" style="display:none">
      <div class="section-title">Informe anual</div>
      <div class="section-sub">Asistencia completa del aÃ±o</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="prof-an-curso" onchange="poblarAlumnosProfesor('an')" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">Alumno</label>
        <select id="prof-an-alumno" style="margin-bottom:14px">
          <option value="">Primero elegÃ­ el curso...</option>
        </select>
        <button class="btn-primary" onclick="generarInformeProfesor('anual')">ğŸ“„ Generar informe PDF</button>
      </div>
    </div>

    <!-- TAB POR FECHAS -->
    <div id="proftab-fechas" style="display:none">
      <div class="section-title">Informe por fechas</div>
      <div class="section-sub">ConsultÃ¡ la asistencia en un rango de dÃ­as</div>
      <div class="card">
        <label class="field-label">Curso</label>
        <select id="prof-fec-curso" onchange="poblarAlumnosProfesor('fec')" style="margin-bottom:14px">
          <option value="">SeleccionÃ¡ un curso...</option>
        </select>
        <label class="field-label">Alumno</label>
        <select id="prof-fec-alumno" style="margin-bottom:14px">
          <option value="">Primero elegÃ­ el curso...</option>
        </select>
        <label class="field-label">Desde</label>
        <input type="date" id="prof-fec-desde" style="margin-bottom:14px">
        <label class="field-label">Hasta</label>
        <input type="date" id="prof-fec-hasta" style="margin-bottom:14px">
        <button class="btn-primary" onclick="generarInformeProfesor('fechas')">ğŸ“„ Generar informe PDF</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-bg" id="modal-bg" onclick="cerrarModal(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-title">â€”</div>
    <div class="modal-sub" id="modal-sub">â€”</div>
    <div id="modal-body"></div>
  </div>
</div>

<div class="saving-overlay" id="saving-overlay">
  <div class="saving-spinner"></div>
  <div class="saving-text" id="saving-text">Guardando...</div>
</div>

<div class="toast" id="toast"></div>

<script>
// =============================================
// CONFIGURACIÃ“N â€” URL del script
// =============================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwvWAnVb7Bf-XLEwniu1M2PHNhSCqIKohziSnKZFnfFVMsUGqJThwz0tV4pk8CY4s7v/exec';

// =============================================
// ESTADO GLOBAL
// =============================================
let datos = { usuarios: [], cursos: [], alumnos: [] };
let currentUser = null;
let attendance = {};
let allRegistros = JSON.parse(localStorage.getItem('cens_registros_v2') || '[]'); // cache local, se reemplaza con Sheet

// =============================================
// CARGA INICIAL DESDE GOOGLE SHEETS
// =============================================
async function cargarRegistrosDesdeSheet() {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), 8000);
  try {
    const res = await fetch(SCRIPT_URL + '?action=getRegistros', { signal: controller.signal });
    clearTimeout(timer);
    const json = await res.json();
    if (json.status === 'ok' && json.registros) {
      allRegistros = json.registros;
      localStorage.setItem('cens_registros_v2', JSON.stringify(allRegistros));
      return true;
    }
  } catch(e) {
    clearTimeout(timer);
    // Si falla, usar cache local
    const cache = localStorage.getItem('cens_registros_v2');
    if (cache) { allRegistros = JSON.parse(cache); return true; }
  }
  return false;
}

async function cargarDatos() {
  try {
    const res = await fetch(SCRIPT_URL + '?action=getDatos');
    const json = await res.json();
    if (json.status === 'ok') {
      datos = json;
      localStorage.setItem('cens_datos_cache', JSON.stringify(datos));
      return true;
    }
  } catch(e) {
    // Intentar cache local
    const cache = localStorage.getItem('cens_datos_cache');
    if (cache) {
      datos = JSON.parse(cache);
      return true;
    }
  }
  return false;
}

async function init() {
  // Cargar datos maestros Y registros de asistencia desde Sheet
  const [okDatos] = await Promise.all([
    cargarDatos(),
    cargarRegistrosDesdeSheet()
  ]);
  document.getElementById('screen-loading').style.display = 'none';

  if (okDatos) {
    poblarLogin();
    document.getElementById('screen-bienvenida').style.display = 'flex';
  } else {
    document.getElementById('screen-loading').innerHTML = `
      <div style="color:white;text-align:center;padding:30px">
        <div style="font-size:48px;margin-bottom:16px">âš ï¸</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:8px">Sin conexiÃ³n</div>
        <div style="font-size:14px;opacity:.8;margin-bottom:24px">No se pudo conectar con Google Sheets</div>
        <button onclick="location.reload()" style="background:white;color:#2563eb;border:none;padding:12px 24px;border-radius:12px;font-family:inherit;font-size:15px;font-weight:700;cursor:pointer">Reintentar</button>
      </div>`;
  }
}

async function recargarDatos() {
  document.getElementById('screen-inicio').style.display = 'none';
  document.getElementById('screen-loading').style.display = 'flex';
  await init();
}

function poblarLogin() {
  const sel = document.getElementById('sel-usuario');
  sel.innerHTML = '<option value="">SeleccionÃ¡...</option>';
  datos.usuarios
    .filter(u => (u.activo === 'SI' || u.activo === true) && u.rol !== 'Directora')
    .forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.nombre;
      opt.textContent = u.nombre;
      sel.appendChild(opt);
    });
}

// =============================================
// LOGIN
// =============================================
function login() {
  const pass = document.getElementById('inp-pass').value;
  const err = document.getElementById('login-error');
  err.style.display = 'none';

  let usuario;
  if (rolSeleccionado === 'directora') {
    usuario = datos.usuarios.find(u => u.rol === 'Directora');
    if (!usuario || String(usuario.password) !== pass) { err.textContent = 'ContraseÃ±a incorrecta'; err.style.display = 'block'; return; }
  } else {
    const nombre = document.getElementById('sel-usuario').value;
    if (!nombre) { err.textContent = 'SeleccionÃ¡ tu nombre'; err.style.display = 'block'; return; }
    usuario = datos.usuarios.find(u => u.nombre === nombre);
    if (!usuario) { err.textContent = 'Usuario no encontrado'; err.style.display = 'block'; return; }
    if (String(usuario.password) !== pass) { err.textContent = 'ContraseÃ±a incorrecta'; err.style.display = 'block'; return; }
  }

  currentUser = usuario;
  document.getElementById('screen-inicio').style.display = 'none';
  document.getElementById('screen-app').style.display = 'flex';
  document.getElementById('tb-name').textContent = usuario.nombre;
  document.getElementById('tb-role').textContent = usuario.rol === 'Directora' ? 'DirecciÃ³n' : 'Preceptor/a';
  document.getElementById('tb-avatar').textContent = usuario.nombre[0].toUpperCase();

  if (usuario.rol === 'Directora') initDirectora();
  else initPreceptor();
}

function logout() {
  currentUser = null;
  document.getElementById('screen-app').style.display = 'none';
  document.getElementById('view-profesor').style.display = 'none';
  document.getElementById('screen-inicio').style.display = 'flex';
  document.getElementById('screen-app').style.display = 'none';
  document.getElementById('inp-pass').value = '';
  document.getElementById('view-preceptor').style.display = 'none';
  document.getElementById('view-directora').style.display = 'none';
}

// =============================================
// PRECEPTOR
// =============================================
async function initPreceptor() {
  document.getElementById('screen-app').style.display = 'block';
  document.getElementById('view-preceptor').style.display = 'block';
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('inp-fecha').value = today;
  setTimeout(verificarHoraLimite, 100);
  setInterval(verificarHoraLimite, 60000);
  // Cargar registros frescos desde Sheet
  mostrarGuardando('Cargando asistencia...');
  await cargarRegistrosDesdeSheet();
  ocultarGuardando();
  renderLista();
  document.getElementById('p-curso-sub').textContent = 'SeleccionÃ¡ el curso y la fecha';

  const misCursos = datos.cursos.filter(c => c.preceptor === currentUser.nombre);
  const sel = document.getElementById('sel-curso');
  sel.innerHTML = '<option value="">ElegÃ­ un curso...</option>';
  misCursos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.nombre;
    sel.appendChild(opt);
  });

  if (misCursos.length === 1) {
    sel.value = misCursos[0].id;
    renderLista();
  }
}

function verificarHoraLimite() {
  const ahora = new Date();
  const horaActual = ahora.getHours();
  const minActual = ahora.getMinutes();
  const fechaHoy = ahora.toISOString().split('T')[0];
  const fechaLista = document.getElementById('inp-fecha') ? document.getElementById('inp-fecha').value : '';
  const btnGuardar = document.getElementById('btn-guardar-lista');
  const lblBloqueado = document.getElementById('lista-bloqueada');
  const avisoHora = document.getElementById('aviso-hora');
  if (!btnGuardar) return;

  const esHoy = fechaLista === fechaHoy;
  const bloqueado = esHoy && horaActual >= 20;
  const minutosRestantes = esHoy ? (20 - horaActual - 1) * 60 + (60 - minActual) : null;

  if (bloqueado) {
    // Bloqueo permanente
    btnGuardar.disabled = true;
    btnGuardar.style.opacity = '0.4';
    btnGuardar.style.cursor = 'not-allowed';
    if (lblBloqueado) lblBloqueado.style.display = 'block';
    if (avisoHora) avisoHora.style.display = 'none';
  } else {
    btnGuardar.disabled = false;
    btnGuardar.style.opacity = '1';
    btnGuardar.style.cursor = 'pointer';
    if (lblBloqueado) lblBloqueado.style.display = 'none';

    // Mostrar avisos progresivos solo para lista de hoy
    if (avisoHora && esHoy) {
      if (horaActual === 19 && minActual >= 30) {
        // Menos de 30 minutos â€” aviso rojo urgente
        avisoHora.style.display = 'block';
        avisoHora.style.background = '#fef2f2';
        avisoHora.style.border = '1px solid #fca5a5';
        avisoHora.style.color = '#dc2626';
        avisoHora.textContent = `âš ï¸ Quedan ${60 - minActual} minutos para el cierre â€” Â¡GuardÃ¡ la lista antes de las 20:00hs!`;
      } else if (horaActual === 19) {
        // Entre 19:00 y 19:30 â€” aviso amarillo
        avisoHora.style.display = 'block';
        avisoHora.style.background = '#fffbeb';
        avisoHora.style.border = '1px solid #fcd34d';
        avisoHora.style.color = '#92400e';
        avisoHora.textContent = `â° La lista se cierra a las 20:00hs â€” No olvides presionar Guardar`;
      } else {
        avisoHora.style.display = 'none';
      }
    } else if (avisoHora) {
      avisoHora.style.display = 'none';
    }
  }
}

function renderLista() {
  const cursoId = document.getElementById('sel-curso').value;
  if (!cursoId) { document.getElementById('lista-wrap').style.display = 'none'; return; }

  const curso = datos.cursos.find(c => c.id === cursoId);
  const fecha = document.getElementById('inp-fecha').value;
  const key = `${cursoId}_${fecha}`;
  const alumnos = datos.alumnos.filter(a => a.idCurso === cursoId && (a.activo === 'SI' || a.activo === true));

  if (!attendance[key]) {
    attendance[key] = {};
    alumnos.forEach(a => attendance[key][a.nombre] = 'Presente');
  }

  const listEl = document.getElementById('lista-alumnos');
  listEl.innerHTML = '';
  alumnos.forEach((alumno, i) => {
    const est = attendance[key][alumno.nombre] || 'Presente';
    const div = document.createElement('div');
    div.className = 'alumno-item';
    div.innerHTML = `
      <div>
        <div class="alumno-name">${alumno.nombre}</div>
        <div class="alumno-num">#${String(i+1).padStart(2,'0')}</div>
      </div>
      <div class="estado-btns">
        <button class="est-btn ${est==='Presente'?'p-active':''}" onclick="setEst('${key}','${alumno.nombre}','Presente',this)" title="Presente">âœ“</button>
        <button class="est-btn ${est==='Tardanza'?'t-active':''}" onclick="setEst('${key}','${alumno.nombre}','Tardanza',this)" title="Tardanza">â°</button>
        <button class="est-btn ${est==='Ausente'?'a-active':''}" onclick="setEst('${key}','${alumno.nombre}','Ausente',this)" title="Ausente">âœ—</button>
      </div>`;
    listEl.appendChild(div);
  });

  document.getElementById('lista-wrap').style.display = 'block';
  updateCounts(key);
}

function setEst(key, alumno, estado, btn) {
  attendance[key][alumno] = estado;
  const row = btn.closest('.estado-btns');
  row.querySelectorAll('.est-btn').forEach(b => b.classList.remove('p-active','a-active','t-active'));
  btn.classList.add(estado==='Presente'?'p-active':estado==='Ausente'?'a-active':'t-active');
  updateCounts(key);
}

function updateCounts(key) {
  const vals = Object.values(attendance[key] || {});
  document.getElementById('cnt-p').textContent = vals.filter(v=>v==='Presente').length;
  document.getElementById('cnt-a').textContent = vals.filter(v=>v==='Ausente').length;
  document.getElementById('cnt-t').textContent = vals.filter(v=>v==='Tardanza').length;
}

async function guardarLista() {
  // Verificar hora lÃ­mite 20:00
  const ahora = new Date();
  const horaActual = ahora.getHours();
  const fechaHoy = ahora.toISOString().split('T')[0];
  const fechaLista = document.getElementById('inp-fecha').value;
  if (fechaLista === fechaHoy && horaActual >= 20) {
    showToast('Lista cerrada Â· No se puede modificar despuÃ©s de las 20:00hs', 'error');
    return;
  }

  const cursoId = document.getElementById('sel-curso').value;
  const fecha = document.getElementById('inp-fecha').value;
  if (!cursoId || !fecha) return;

  const key = `${cursoId}_${fecha}`;
  const data = attendance[key];
  if (!data) return;

  const curso = datos.cursos.find(c => c.id === cursoId);
  const rows = Object.entries(data).map(([alumno, estado]) => {
    const alumnoObj = datos.alumnos.find(a => a.nombre === alumno && a.idCurso === cursoId);
    return {
      fecha, idCurso: cursoId, curso: curso.nombre,
      preceptor: currentUser.nombre,
      idAlumno: alumnoObj ? alumnoObj.id : '',
      alumno, estado
    };
  });

  // Guardar localmente
  const registro = { key, fecha, curso: curso.nombre, idCurso: cursoId, preceptor: currentUser.nombre, data, timestamp: new Date().toISOString() };
  const idx = allRegistros.findIndex(r => r.key === key);
  if (idx >= 0) allRegistros[idx] = registro; else allRegistros.push(registro);
  localStorage.setItem('cens_registros_v2', JSON.stringify(allRegistros));

  // Enviar a Google Sheets
  mostrarGuardando('Enviando a Google Sheets...');
  try {
    await fetch(SCRIPT_URL, {
      method: 'POST', mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'registrar', rows })
    });
    ocultarGuardando();
    showToast('âœ“ Lista guardada y enviada', 'success');
  } catch(e) {
    ocultarGuardando();
    showToast('âœ“ Guardado. Sin conexiÃ³n al servidor.', 'success');
  }

  renderHistorial();
}

function renderHistorial() {
  const el = document.getElementById('historial-list');
  const misCursos = datos.cursos.filter(c => c.preceptor === currentUser.nombre).map(c => c.id);
  const registros = allRegistros.filter(r => misCursos.includes(r.idCurso)).sort((a,b) => b.fecha.localeCompare(a.fecha));

  if (!registros.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-txt">TodavÃ­a no guardaste ninguna lista</div></div>`;
    return;
  }

  el.innerHTML = registros.map(r => {
    const vals = Object.values(r.data);
    const p = vals.filter(v=>v==='Presente').length;
    const a = vals.filter(v=>v==='Ausente').length;
    const t = vals.filter(v=>v==='Tardanza').length;
    const pct = vals.length ? Math.round(p/vals.length*100) : 0;
    return `<div class="hist-card" onclick="verDetalle('${r.key}')">
      <div class="hist-card-top">
        <div><div class="hist-curso">${r.curso}</div><div class="hist-fecha">ğŸ“… ${formatFecha(r.fecha)}</div></div>
        <span class="chip ${pct>=75?'chip-p':'chip-t'}">${pct}%</span>
      </div>
      <div style="display:flex;gap:6px">
        <span class="chip chip-p">P ${p}</span>
        <span class="chip chip-a">A ${a}</span>
        <span class="chip chip-t">T ${t}</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

function pTab(tab, btn) {
  document.querySelectorAll('#view-preceptor .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('ptab-lista').style.display = tab==='lista' ? 'block' : 'none';
  document.getElementById('ptab-historial').style.display = tab==='historial' ? 'block' : 'none';
  document.getElementById('ptab-informe').style.display = tab==='informe' ? 'block' : 'none';
  document.getElementById('ptab-fechas').style.display = tab==='fechas' ? 'block' : 'none';
  document.getElementById('ptab-progresar').style.display = tab==='progresar' ? 'block' : 'none';
  document.getElementById('ptab-salida').style.display = tab==='salida' ? 'block' : 'none';
  if (tab === 'fechas') poblarCursosFechas('p');
  if (tab === 'progresar') poblarCursosProgresar();
  if (tab === 'salida') poblarCursosSalida();
  if (tab === 'historial') renderHistorial();
  if (tab === 'informe') poblarCursosInforme('p');
}

// =============================================
// DIRECTORA
// =============================================
async function initDirectora() {
  document.getElementById('screen-app').style.display = 'block';
  document.getElementById('view-directora').style.display = 'block';
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dir-fecha-lbl').textContent = `Hoy: ${formatFecha(today)}`;
  document.getElementById('buscar-fecha').value = today;
  mostrarGuardando('Cargando datos desde Google Sheets...');
  const ok = await cargarRegistrosDesdeSheet();
  ocultarGuardando();
  renderResumen(today);
  if (!ok) showToast('Sin conexiÃ³n Â· Mostrando datos en cachÃ©', '');
}

async function cargarRegistrosYResumen() {
  mostrarGuardando('Cargando registros desde Google Sheets...');
  const ok = await cargarRegistrosDesdeSheet();
  ocultarGuardando();
  const today = new Date().toISOString().split('T')[0];
  renderResumen(today);
  if (ok) showToast('âœ“ Datos actualizados', 'success');
  else showToast('Sin conexiÃ³n Â· Datos en cachÃ©', '');
}

function renderResumen(fecha) {
  let totalP = 0, totalA = 0, cursosConLista = 0;

  const html = datos.cursos.map(c => {
    const reg = allRegistros.find(r => r.idCurso === c.id && r.fecha === fecha);
    let p=0, a=0, t=0, pct=null;
    if (reg) {
      cursosConLista++;
      const vals = Object.values(reg.data);
      p = vals.filter(v=>v==='Presente').length;
      a = vals.filter(v=>v==='Ausente').length;
      t = vals.filter(v=>v==='Tardanza').length;
      totalP += p; totalA += a;
      pct = vals.length ? Math.round(p/vals.length*100) : 0;
    }
    const key = `${c.id}_${fecha}`;
    return `<div class="dir-card" onclick="verDetalle('${key}')">
      <div class="dir-card-top">
        <div><div class="dir-curso">${c.nombre}</div><div class="dir-preceptor">ğŸ‘¤ ${c.preceptor}</div></div>
        ${pct!==null ? `<span class="badge ${pct>=75?'badge-ok':'badge-warn'}">${pct}%</span>` : '<span class="badge badge-none">Sin lista</span>'}
      </div>
      ${pct!==null ? `<div style="display:flex;gap:6px;margin-top:10px">
        <span class="chip chip-p">P ${p}</span>
        <span class="chip chip-a">A ${a}</span>
        <span class="chip chip-t">T ${t}</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>` : ''}
    </div>`;
  }).join('');

  document.getElementById('dir-cursos-list').innerHTML = html || `<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-txt">No hay registros para hoy todavÃ­a</div></div>`;
  document.getElementById('dir-p').textContent = totalP;
  document.getElementById('dir-a').textContent = totalA;
  document.getElementById('dir-cursos').textContent = `${cursosConLista}/${datos.cursos.length}`;
}

function filtrar() {
  const fecha = document.getElementById('buscar-fecha').value;
  const nombre = document.getElementById('buscar-nombre').value.toLowerCase();
  const el = document.getElementById('buscar-results');
  let registros = allRegistros.filter(r => !fecha || r.fecha === fecha);

  if (!registros.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-txt">Sin resultados</div></div>`;
    return;
  }

  let html = '';
  registros.forEach(r => {
    let alumnos = Object.entries(r.data).filter(([n]) => !nombre || n.toLowerCase().includes(nombre));
    if (!alumnos.length) return;
    html += `<div class="card"><div style="font-weight:700;margin-bottom:4px">${r.curso}</div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:12px">ğŸ“… ${formatFecha(r.fecha)} Â· ğŸ‘¤ ${r.preceptor}</div>
    ${alumnos.map(([n,e])=>`<div class="modal-row"><span>${n}</span><span class="chip ${e==='Presente'?'chip-p':e==='Ausente'?'chip-a':'chip-t'}">${e}</span></div>`).join('')}
    </div>`;
  });
  el.innerHTML = html || `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-txt">Sin resultados</div></div>`;
}

function dTab(tab, btn) {
  document.querySelectorAll('#view-directora .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('dtab-resumen').style.display = tab==='resumen' ? 'block' : 'none';
  document.getElementById('dtab-buscar').style.display = tab==='buscar' ? 'block' : 'none';
  document.getElementById('dtab-informe').style.display = tab==='informe' ? 'block' : 'none';
  document.getElementById('dtab-fechas').style.display = tab==='fechas' ? 'block' : 'none';
  document.getElementById('dtab-progresar').style.display = tab==='progresar' ? 'block' : 'none';
  document.getElementById('dtab-exportar').style.display = tab==='exportar' ? 'block' : 'none';
  if (tab === 'fechas') poblarCursosFechas('d');
  if (tab === 'progresar') cargarProgresar();
  if (tab === 'exportar') cargarDatosExportar();
  if (tab === 'informe') poblarCursosInforme('d');
}

// =============================================
// MODAL
// =============================================
function verDetalle(key) {
  const reg = allRegistros.find(r => r.key === key);
  document.getElementById('modal-title').textContent = reg ? reg.curso : 'Sin datos';
  document.getElementById('modal-sub').textContent = reg ? `ğŸ“… ${formatFecha(reg.fecha)} Â· ğŸ‘¤ ${reg.preceptor}` : 'Lista no tomada todavÃ­a';

  if (!reg) {
    document.getElementById('modal-body').innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-txt">Lista no tomada</div></div>`;
  } else {
    const vals = Object.values(reg.data);
    const p = vals.filter(v=>v==='Presente').length;
    const a = vals.filter(v=>v==='Ausente').length;
    const t = vals.filter(v=>v==='Tardanza').length;
    document.getElementById('modal-body').innerHTML = `
      <div class="stats-row" style="margin-bottom:16px">
        <div class="stat-card s-green"><div class="stat-num">${p}</div><div class="stat-lbl">Presentes</div></div>
        <div class="stat-card s-red"><div class="stat-num">${a}</div><div class="stat-lbl">Ausentes</div></div>
        <div class="stat-card s-yellow"><div class="stat-num">${t}</div><div class="stat-lbl">Tardanzas</div></div>
      </div>
      ${Object.entries(reg.data).map(([n,e])=>`
        <div class="modal-row">
          <span style="font-size:14px">${n}</span>
          <span class="chip ${e==='Presente'?'chip-p':e==='Ausente'?'chip-a':'chip-t'}">${e==='Presente'?'âœ“ Presente':e==='Ausente'?'âœ— Ausente':'â° Tardanza'}</span>
        </div>`).join('')}`;
  }
  document.getElementById('modal-bg').classList.add('open');
}

function cerrarModal(e) {
  if (e.target === document.getElementById('modal-bg')) document.getElementById('modal-bg').classList.remove('open');
}

// =============================================
// UTILS
// =============================================
function formatFecha(f) {
  if (!f) return 'â€”';
  const [y,m,d] = f.split('-');
  const meses = ['','enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
  return `${parseInt(d)} de ${meses[parseInt(m)]} de ${y}`;
}

function mostrarGuardando(txt) {
  document.getElementById('saving-text').textContent = txt || 'Guardando...';
  document.getElementById('saving-overlay').classList.add('show');
}
function ocultarGuardando() { document.getElementById('saving-overlay').classList.remove('show'); }

function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3000);
}

// =============================================
// PANTALLA BIENVENIDA
// =============================================
let rolSeleccionado = '';

function elegirRol(rol) {
  rolSeleccionado = rol;
  document.getElementById('screen-bienvenida').style.display = 'none';
  document.getElementById('screen-inicio').style.display = 'flex';

  if (rol === 'preceptor') {
    document.getElementById('login-title').textContent = 'Preceptor/a';
    document.getElementById('login-sub').textContent = 'SeleccionÃ¡ tu nombre e ingresÃ¡ tu contraseÃ±a';
    document.getElementById('campo-preceptor').style.display = 'block';
  } else {
    document.getElementById('login-title').textContent = 'Directora';
    document.getElementById('login-sub').textContent = 'IngresÃ¡ tu contraseÃ±a';
    document.getElementById('campo-preceptor').style.display = 'none';
  }
}

function volverBienvenida() {
  document.getElementById('screen-inicio').style.display = 'none';
  document.getElementById('screen-bienvenida').style.display = 'flex';
  document.getElementById('inp-pass').value = '';
  document.getElementById('login-error').style.display = 'none';
}

// =============================================
// GENERAR PDF
// =============================================
function generarPDF() {
  const cursoId = document.getElementById('sel-curso').value;
  const fecha = document.getElementById('inp-fecha').value;
  if (!cursoId || !fecha) { showToast('SeleccionÃ¡ curso y fecha primero', 'error'); return; }

  const key = `${cursoId}_${fecha}`;
  const data = attendance[key];
  if (!data || Object.keys(data).length === 0) { showToast('Primero tomÃ¡ la lista', 'error'); return; }

  const curso = datos.cursos.find(c => c.id === cursoId);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  const W = 210; // ancho A4
  const margin = 18;

  // â”€â”€ ENCABEZADO â”€â”€
  doc.setFillColor(37, 99, 235);
  doc.rect(0, 0, W, 38, 'F');

  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('CENS â€“ Registro de Asistencia', margin, 16);

  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text(`Curso: ${curso.nombre}   |   Preceptor/a: ${curso.preceptor}`, margin, 25);
  doc.text(`Fecha: ${formatFecha(fecha)}`, margin, 32);

  // â”€â”€ STATS â”€â”€
  const vals = Object.values(data);
  const p = vals.filter(v=>v==='Presente').length;
  const a = vals.filter(v=>v==='Ausente').length;
  const t = vals.filter(v=>v==='Tardanza').length;
  const total = vals.length;
  const pct = total ? Math.round(p/total*100) : 0;

  let y = 50;

  // Cajas de estadÃ­sticas
  const boxW = 50; const boxH = 20; const gap = 8;
  const startX = margin;

  // Presentes
  doc.setFillColor(220, 252, 231); doc.setDrawColor(22, 163, 74);
  doc.roundedRect(startX, y, boxW, boxH, 3, 3, 'FD');
  doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.setTextColor(22, 163, 74);
  doc.text(String(p), startX + boxW/2, y + 12, {align:'center'});
  doc.setFontSize(8); doc.setFont('helvetica','normal');
  doc.text('PRESENTES', startX + boxW/2, y + 18, {align:'center'});

  // Ausentes
  const x2 = startX + boxW + gap;
  doc.setFillColor(254, 226, 226); doc.setDrawColor(220, 38, 38);
  doc.roundedRect(x2, y, boxW, boxH, 3, 3, 'FD');
  doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.setTextColor(220, 38, 38);
  doc.text(String(a), x2 + boxW/2, y + 12, {align:'center'});
  doc.setFontSize(8); doc.setFont('helvetica','normal');
  doc.text('AUSENTES', x2 + boxW/2, y + 18, {align:'center'});

  // Tardanzas
  const x3 = x2 + boxW + gap;
  doc.setFillColor(254, 243, 199); doc.setDrawColor(217, 119, 6);
  doc.roundedRect(x3, y, boxW, boxH, 3, 3, 'FD');
  doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.setTextColor(217, 119, 6);
  doc.text(String(t), x3 + boxW/2, y + 12, {align:'center'});
  doc.setFontSize(8); doc.setFont('helvetica','normal');
  doc.text('TARDANZAS', x3 + boxW/2, y + 18, {align:'center'});

  // Porcentaje
  const x4 = x3 + boxW + gap;
  doc.setFillColor(239, 246, 255); doc.setDrawColor(37, 99, 235);
  doc.roundedRect(x4, y, boxW, boxH, 3, 3, 'FD');
  doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.setTextColor(37, 99, 235);
  doc.text(pct + '%', x4 + boxW/2, y + 12, {align:'center'});
  doc.setFontSize(8); doc.setFont('helvetica','normal');
  doc.text('ASISTENCIA', x4 + boxW/2, y + 18, {align:'center'});

  y += 30;

  // â”€â”€ TABLA DE ALUMNOS â”€â”€
  // Encabezado tabla
  doc.setFillColor(37, 99, 235);
  doc.rect(margin, y, W - margin*2, 8, 'F');
  doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('#', margin + 4, y + 5.5);
  doc.text('Apellido y Nombre', margin + 12, y + 5.5);
  doc.text('Estado', W - margin - 25, y + 5.5);
  y += 8;

  // Filas
  const alumnos = Object.entries(data);
  alumnos.forEach(([nombre, estado], i) => {
    // Color de fondo alternado
    if (i % 2 === 0) {
      doc.setFillColor(248, 250, 252);
      doc.rect(margin, y, W - margin*2, 7, 'F');
    }

    // Color del estado
    if (estado === 'Presente') {
      doc.setFillColor(220, 252, 231);
      doc.roundedRect(W - margin - 28, y + 1, 26, 5, 1, 1, 'F');
      doc.setTextColor(22, 163, 74);
    } else if (estado === 'Ausente') {
      doc.setFillColor(254, 226, 226);
      doc.roundedRect(W - margin - 28, y + 1, 26, 5, 1, 1, 'F');
      doc.setTextColor(220, 38, 38);
    } else {
      doc.setFillColor(254, 243, 199);
      doc.roundedRect(W - margin - 28, y + 1, 26, 5, 1, 1, 'F');
      doc.setTextColor(217, 119, 6);
    }

    doc.setFontSize(8); doc.setFont('helvetica','normal');
    doc.setTextColor(100, 116, 139);
    doc.text(String(i+1).padStart(2,'0'), margin + 4, y + 5);

    doc.setTextColor(30, 41, 59);
    doc.text(nombre, margin + 12, y + 5);

    doc.setFont('helvetica','bold');
    if (estado === 'Presente') doc.setTextColor(22, 163, 74);
    else if (estado === 'Ausente') doc.setTextColor(220, 38, 38);
    else doc.setTextColor(217, 119, 6);
    doc.text(estado, W - margin - 15, y + 5, {align:'center'});

    y += 7;

    // Nueva pÃ¡gina si es necesario
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
  });

  // â”€â”€ FIRMA â”€â”€
  y += 10;
  doc.setDrawColor(200, 210, 220);
  doc.line(margin, y, margin + 60, y);
  doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(100, 116, 139);
  doc.text('Firma del Preceptor/a', margin, y + 5);

  // â”€â”€ PIE â”€â”€
  doc.setFontSize(7); doc.setTextColor(150, 160, 175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});

  // â”€â”€ DESCARGAR â”€â”€
  const nombreArchivo = `Asistencia_${curso.nombre.replace(/[^a-zA-Z0-9]/g,'_')}_${fecha}.pdf`;
  doc.save(nombreArchivo);
  showToast('âœ“ PDF descargado', 'success');
}

// =============================================
// PDF RESUMEN DIRECTORA
// =============================================
function generarPDFResumen() {
  const today = new Date().toISOString().split('T')[0];
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const W = 210; const margin = 18;

  // â”€â”€ ENCABEZADO â”€â”€
  doc.setFillColor(37, 99, 235);
  doc.rect(0, 0, W, 42, 'F');

  doc.setFontSize(20); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('CENS â€“ Resumen de Asistencia', margin, 17);

  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text(`Fecha: ${formatFecha(today)}`, margin, 27);
  doc.text(`Generado por: DirecciÃ³n`, margin, 34);

  // â”€â”€ TOTALES GENERALES â”€â”€
  let totalP=0, totalA=0, totalT=0, totalAlumnos=0, cursosConLista=0;
  datos.cursos.forEach(c => {
    const reg = allRegistros.find(r => r.idCurso === c.id && r.fecha === today);
    if (reg) {
      const vals = Object.values(reg.data);
      totalP += vals.filter(v=>v==='Presente').length;
      totalA += vals.filter(v=>v==='Ausente').length;
      totalT += vals.filter(v=>v==='Tardanza').length;
      totalAlumnos += vals.length;
      cursosConLista++;
    }
  });
  const pctTotal = totalAlumnos ? Math.round(totalP/totalAlumnos*100) : 0;

  let y = 52;

  // Cajas totales
  const boxW = 38; const boxH = 18; const gap = 6;
  const boxes = [
    { label:'PRESENTES', val:totalP, r:220, g:252, b:231, tr:22, tg:163, tb:74, dr:22, dg:163, db:74 },
    { label:'AUSENTES', val:totalA, r:254, g:226, b:226, tr:220, tg:38, tb:38, dr:220, dg:38, db:38 },
    { label:'TARDANZAS', val:totalT, r:254, g:243, b:199, tr:217, tg:119, tb:6, dr:217, dg:119, db:6 },
    { label:'% ASIST.', val:pctTotal+'%', r:239, g:246, b:255, tr:37, tg:99, tb:235, dr:37, dg:99, db:235 },
    { label:'CURSOS', val:cursosConLista+'/'+datos.cursos.length, r:245, g:243, b:255, tr:99, tg:102, tb:241, dr:99, dg:102, db:241 },
  ];

  boxes.forEach((box, i) => {
    const bx = margin + i * (boxW + gap);
    doc.setFillColor(box.r, box.g, box.b);
    doc.setDrawColor(box.dr, box.dg, box.db);
    doc.roundedRect(bx, y, boxW, boxH, 3, 3, 'FD');
    doc.setFontSize(14); doc.setFont('helvetica','bold');
    doc.setTextColor(box.tr, box.tg, box.tb);
    doc.text(String(box.val), bx + boxW/2, y + 11, {align:'center'});
    doc.setFontSize(7); doc.setFont('helvetica','normal');
    doc.text(box.label, bx + boxW/2, y + 16, {align:'center'});
  });

  y += 26;

  // â”€â”€ TABLA POR CURSO â”€â”€
  // Encabezado
  doc.setFillColor(37, 99, 235);
  doc.rect(margin, y, W - margin*2, 8, 'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Curso', margin + 3, y + 5.5);
  doc.text('Preceptor/a', margin + 55, y + 5.5);
  doc.text('P', margin + 105, y + 5.5, {align:'center'});
  doc.text('A', margin + 118, y + 5.5, {align:'center'});
  doc.text('T', margin + 131, y + 5.5, {align:'center'});
  doc.text('Total', margin + 144, y + 5.5, {align:'center'});
  doc.text('% Asist.', W - margin - 8, y + 5.5, {align:'center'});
  y += 8;

  datos.cursos.forEach((c, i) => {
    const reg = allRegistros.find(r => r.idCurso === c.id && r.fecha === today);
    let p=0, a=0, t=0, tot=0, pct='â€”';

    if (reg) {
      const vals = Object.values(reg.data);
      p = vals.filter(v=>v==='Presente').length;
      a = vals.filter(v=>v==='Ausente').length;
      t = vals.filter(v=>v==='Tardanza').length;
      tot = vals.length;
      pct = tot ? Math.round(p/tot*100)+'%' : 'â€”';
    }

    // Fondo alternado
    if (i % 2 === 0) { doc.setFillColor(248,250,252); doc.rect(margin, y, W-margin*2, 7, 'F'); }

    doc.setFontSize(8); doc.setFont('helvetica', reg ? 'normal' : 'normal');
    doc.setTextColor(30, 41, 59);
    doc.text(c.nombre, margin + 3, y + 5);
    doc.text(c.preceptor, margin + 55, y + 5);

    if (reg) {
      doc.setTextColor(22,163,74); doc.setFont('helvetica','bold');
      doc.text(String(p), margin + 105, y + 5, {align:'center'});
      doc.setTextColor(220,38,38);
      doc.text(String(a), margin + 118, y + 5, {align:'center'});
      doc.setTextColor(217,119,6);
      doc.text(String(t), margin + 131, y + 5, {align:'center'});
      doc.setTextColor(30,41,59);
      doc.text(String(tot), margin + 144, y + 5, {align:'center'});
      const pctNum = tot ? Math.round(p/tot*100) : 0;
      doc.setTextColor(pctNum >= 75 ? 22 : 220, pctNum >= 75 ? 163 : 38, pctNum >= 75 ? 74 : 38);
      doc.text(pct, W - margin - 8, y + 5, {align:'center'});
    } else {
      doc.setTextColor(150,160,175);
      doc.text('Sin lista', margin + 118, y + 5, {align:'center'});
    }

    y += 7;
    if (y > 270) { doc.addPage(); y = 20; }
  });

  // â”€â”€ FIRMA DIRECTORA â”€â”€
  y += 14;
  doc.setDrawColor(200,210,220);
  doc.line(margin, y, margin + 70, y);
  doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(100,116,139);
  doc.text('Firma de la Directora', margin, y + 5);

  // â”€â”€ PIE â”€â”€
  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});

  doc.save(`Resumen_Asistencia_${today}.pdf`);
  showToast('âœ“ PDF resumen descargado', 'success');
}

// =============================================
// ARRANCAR
// =============================================
init();

// =============================================
// INFORME CUATRIMESTRAL POR ALUMNO
// =============================================
const CUATRIMESTRES = {
  '1': { label:'1Â° Cuatrimestre', meses:[3,4,5,6], nombres:['Marzo','Abril','Mayo','Junio'] },
  '2': { label:'2Â° Cuatrimestre', meses:[7,8,9,10,11], nombres:['Julio','Agosto','Septiembre','Octubre','Noviembre'] },
  'anual': { label:'Anual', meses:[3,4,5,6,7,8,9,10,11], nombres:['Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre'] }
};

function poblarCursosInforme(pre) {
  const sel = document.getElementById(`inf-${pre}-curso`);
  sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
  const cursos = pre === 'p'
    ? datos.cursos.filter(c => c.preceptor === currentUser.nombre)
    : datos.cursos;
  cursos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.nombre;
    sel.appendChild(opt);
  });
  document.getElementById(`inf-${pre}-alumno`).innerHTML = '<option value="">Primero elegÃ­ el curso...</option>';
}

function poblarAlumnosInforme(pre) {
  const cursoId = document.getElementById(`inf-${pre}-curso`).value;
  const sel = document.getElementById(`inf-${pre}-alumno`);
  sel.innerHTML = '<option value="">SeleccionÃ¡ un alumno...</option>';
  if (!cursoId) return;
  const alumnos = datos.alumnos.filter(a => a.idCurso === cursoId && (a.activo === 'SI' || a.activo === true));
  alumnos.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.nombre; opt.textContent = a.nombre;
    sel.appendChild(opt);
  });
}

function generarInformeAlumno(pre) {
  const cursoId = document.getElementById(`inf-${pre}-curso`).value;
  const alumno = document.getElementById(`inf-${pre}-alumno`).value;
  const periodo = document.getElementById(`inf-${pre}-periodo`).value;
  if (!cursoId || !alumno) { showToast('SeleccionÃ¡ curso y alumno', 'error'); return; }

  const curso = datos.cursos.find(c => c.id === cursoId);
  const cuatri = CUATRIMESTRES[periodo];
  const anio = new Date().getFullYear();

  // Calcular estadÃ­sticas por mes
  const statsPorMes = cuatri.meses.map((mes, i) => {
    const regsDelMes = allRegistros.filter(r => {
      if (r.idCurso !== cursoId) return false;
      const [y, m] = (r.fecha || '').split('-');
      return parseInt(m) === mes && parseInt(y) === anio;
    });
    let p=0, a=0, t=0, dias=0;
    regsDelMes.forEach(r => {
      const estado = r.data[alumno];
      if (estado !== undefined) {
        dias++;
        if (estado === 'Presente') p++;
        else if (estado === 'Ausente') a++;
        else if (estado === 'Tardanza') t++;
      }
    });
    return { mes: cuatri.nombres[i], p, a, t, total: dias };
  });

  const totP = statsPorMes.reduce((s,m)=>s+m.p,0);
  const totA = statsPorMes.reduce((s,m)=>s+m.a,0);
  const totT = statsPorMes.reduce((s,m)=>s+m.t,0);
  const totDias = statsPorMes.reduce((s,m)=>s+m.total,0);
  const pctTotal = totDias ? Math.round(totP/totDias*100) : 0;

  // â”€â”€ GENERAR PDF â”€â”€
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
  const W = 210; const margin = 18;

  // Encabezado
  doc.setFillColor(37,99,235);
  doc.rect(0, 0, W, 46, 'F');
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(180,210,255);
  doc.text('CENS â€“ Sistema de GestiÃ³n de Asistencia', margin, 12);
  doc.setFontSize(19); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Informe de Asistencia', margin, 23);
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text(`${cuatri.label} ${anio}`, margin, 31);
  doc.setFontSize(9);
  doc.text(`Alumno/a: ${alumno}   Â·   Curso: ${curso.nombre}   Â·   Preceptor/a: ${curso.preceptor}`, margin, 39);

  let y = 56;

  // Cajas resumen
  const boxW = 38; const boxH = 20; const gap = 7;
  const boxes = [
    { label:'PRESENTES', val:totP, rf:220,gf:252,bf:231, rt:22,gt:163,bt:74 },
    { label:'AUSENTES', val:totA, rf:254,gf:226,bf:226, rt:220,gt:38,bt:38 },
    { label:'TARDANZAS', val:totT, rf:254,gf:243,bf:199, rt:217,gt:119,bt:6 },
    { label:'DÃAS CLASE', val:totDias, rf:239,gf:246,bf:255, rt:37,gt:99,bt:235 },
    { label:'% ASISTENCIA', val:pctTotal+'%', rf:pctTotal>=75?220:254, gf:pctTotal>=75?252:226, bf:pctTotal>=75?231:226, rt:pctTotal>=75?22:220, gt:pctTotal>=75?163:38, bt:pctTotal>=75?74:38 },
  ];
  boxes.forEach((box, i) => {
    const bx = margin + i*(boxW+gap);
    doc.setFillColor(box.rf,box.gf,box.bf); doc.setDrawColor(box.rt,box.gt,box.bt);
    doc.roundedRect(bx, y, boxW, boxH, 3, 3, 'FD');
    doc.setFontSize(15); doc.setFont('helvetica','bold'); doc.setTextColor(box.rt,box.gt,box.bt);
    doc.text(String(box.val), bx+boxW/2, y+12, {align:'center'});
    doc.setFontSize(6.5); doc.setFont('helvetica','normal');
    doc.text(box.label, bx+boxW/2, y+17, {align:'center'});
  });
  y += 28;

  // Encabezado tabla
  doc.setFillColor(37,99,235); doc.rect(margin, y, W-margin*2, 8, 'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Mes', margin+3, y+5.5);
  doc.text('DÃ­as', margin+65, y+5.5, {align:'center'});
  doc.text('Presentes', margin+95, y+5.5, {align:'center'});
  doc.text('Ausentes', margin+120, y+5.5, {align:'center'});
  doc.text('Tardanzas', margin+145, y+5.5, {align:'center'});
  doc.text('% Asist.', W-margin-5, y+5.5, {align:'right'});
  y += 8;

  statsPorMes.forEach((stat, i) => {
    if (i%2===0) { doc.setFillColor(248,250,252); doc.rect(margin, y, W-margin*2, 8, 'F'); }
    const pct = stat.total ? Math.round(stat.p/stat.total*100) : null;
    doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(30,41,59);
    doc.text(stat.mes, margin+3, y+5.5);
    if (stat.total > 0) {
      doc.text(String(stat.total), margin+65, y+5.5, {align:'center'});
      doc.setTextColor(22,163,74); doc.setFont('helvetica','bold');
      doc.text(String(stat.p), margin+95, y+5.5, {align:'center'});
      doc.setTextColor(220,38,38);
      doc.text(String(stat.a), margin+120, y+5.5, {align:'center'});
      doc.setTextColor(217,119,6);
      doc.text(String(stat.t), margin+145, y+5.5, {align:'center'});
      doc.setTextColor(pct>=75?22:220, pct>=75?163:38, pct>=75?74:38);
      doc.text(pct+'%', W-margin-5, y+5.5, {align:'right'});
    } else {
      doc.setTextColor(150,160,175);
      doc.text('Sin registros', margin+95, y+5.5, {align:'center'});
    }
    y += 8;
  });

  // Fila total
  doc.setFillColor(37,99,235); doc.rect(margin, y, W-margin*2, 9, 'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('TOTAL DEL PERÃODO', margin+3, y+6);
  doc.text(String(totDias), margin+65, y+6, {align:'center'});
  doc.text(String(totP), margin+95, y+6, {align:'center'});
  doc.text(String(totA), margin+120, y+6, {align:'center'});
  doc.text(String(totT), margin+145, y+6, {align:'center'});
  doc.text(pctTotal+'%', W-margin-5, y+6, {align:'right'});
  y += 18;

  // Observaciones
  doc.setDrawColor(200,210,220); doc.setFillColor(248,250,252);
  doc.roundedRect(margin, y, W-margin*2, 30, 3, 3, 'FD');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(30,41,59);
  doc.text('Observaciones:', margin+4, y+8);
  doc.setFont('helvetica','normal'); doc.setTextColor(150,160,175);
  doc.text('..................................................................................................', margin+4, y+16);
  doc.text('..................................................................................................', margin+4, y+23);
  y += 40;

  // Firmas
  doc.setDrawColor(180,190,200);
  doc.line(margin, y, margin+60, y);
  doc.line(W-margin-60, y, W-margin, y);
  doc.setFontSize(8); doc.setTextColor(100,116,139);
  doc.text('Firma Preceptor/a', margin, y+5);
  doc.text('Firma Directora', W-margin-60, y+5);

  // Pie
  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});

  const nombreArchivo = `Informe_${alumno.replace(/[^a-zA-Z0-9]/g,'_')}_${cuatri.label.replace(/ /g,'_')}_${anio}.pdf`;
  doc.save(nombreArchivo);
  showToast('âœ“ Informe generado', 'success');
}

// =============================================
// INFORME POR RANGO DE FECHAS
// =============================================
function poblarCursosFechas(pre) {
  const sel = document.getElementById(`fec-${pre}-curso`);
  sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
  const cursos = pre === 'p' ? datos.cursos.filter(c => c.preceptor === currentUser.nombre) : datos.cursos;
  cursos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.nombre;
    sel.appendChild(opt);
  });
  document.getElementById(`fec-${pre}-alumno`).innerHTML = '<option value="">Primero elegÃ­ el curso...</option>';
  const hoy = new Date().toISOString().split('T')[0];
  if (!document.getElementById(`fec-${pre}-desde`).value)
    document.getElementById(`fec-${pre}-desde`).value = hoy.substring(0,7) + '-01';
  if (!document.getElementById(`fec-${pre}-hasta`).value)
    document.getElementById(`fec-${pre}-hasta`).value = hoy;
}

function poblarAlumnosFechas(pre) {
  const cursoId = document.getElementById(`fec-${pre}-curso`).value;
  const sel = document.getElementById(`fec-${pre}-alumno`);
  sel.innerHTML = '<option value="">SeleccionÃ¡ un alumno...</option>';
  if (!cursoId) return;
  datos.alumnos.filter(a => a.idCurso === cursoId && (a.activo === 'SI' || a.activo === true))
    .forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.nombre; opt.textContent = a.nombre;
      sel.appendChild(opt);
    });
}

function generarInformeFechas(pre) {
  const cursoId = document.getElementById(`fec-${pre}-curso`).value;
  const alumno = document.getElementById(`fec-${pre}-alumno`).value;
  const desde = document.getElementById(`fec-${pre}-desde`).value;
  const hasta = document.getElementById(`fec-${pre}-hasta`).value;
  if (!cursoId || !alumno) { showToast('SeleccionÃ¡ curso y alumno', 'error'); return; }
  if (!desde || !hasta) { showToast('SeleccionÃ¡ las fechas', 'error'); return; }
  if (desde > hasta) { showToast('La fecha inicial debe ser anterior a la final', 'error'); return; }

  const curso = datos.cursos.find(c => c.id === cursoId);
  const regsEnRango = allRegistros
    .filter(r => r.idCurso === cursoId && r.fecha >= desde && r.fecha <= hasta)
    .sort((a,b) => a.fecha.localeCompare(b.fecha));

  let totP=0, totA=0, totT=0, diasConLista=0;
  const detalle = [];
  regsEnRango.forEach(r => {
    const estado = r.data[alumno];
    if (estado !== undefined) {
      diasConLista++;
      if (estado === 'Presente') totP++;
      else if (estado === 'Ausente') totA++;
      else if (estado === 'Tardanza') totT++;
      detalle.push({fecha: r.fecha, estado});
    }
  });
  const pct = diasConLista ? Math.round(totP/diasConLista*100) : 0;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
  const W=210, margin=18;

  doc.setFillColor(37,99,235); doc.rect(0,0,W,50,'F');
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(180,210,255);
  doc.text('CENS â€“ Sistema de GestiÃ³n de Asistencia', margin, 12);
  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Informe de Asistencia por Fechas', margin, 23);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text(`PerÃ­odo: ${formatFecha(desde)} al ${formatFecha(hasta)}`, margin, 32);
  doc.text(`Alumno/a: ${alumno}   Â·   Curso: ${curso.nombre}   Â·   Preceptor/a: ${curso.preceptor}`, margin, 40);

  let y = 58;
  const boxW=38, boxH=20, gap=7;
  const boxes = [
    {label:'PRESENTES', val:totP, rf:220,gf:252,bf:231,rt:22,gt:163,bt:74},
    {label:'AUSENTES', val:totA, rf:254,gf:226,bf:226,rt:220,gt:38,bt:38},
    {label:'TARDANZAS', val:totT, rf:254,gf:243,bf:199,rt:217,gt:119,bt:6},
    {label:'DÃAS CLASE', val:diasConLista, rf:239,gf:246,bf:255,rt:37,gt:99,bt:235},
    {label:'% ASISTENCIA', val:pct+'%', rf:pct>=75?220:254,gf:pct>=75?252:226,bf:pct>=75?231:226,rt:pct>=75?22:220,gt:pct>=75?163:38,bt:pct>=75?74:38},
  ];
  boxes.forEach((box,i) => {
    const bx = margin+i*(boxW+gap);
    doc.setFillColor(box.rf,box.gf,box.bf); doc.setDrawColor(box.rt,box.gt,box.bt);
    doc.roundedRect(bx,y,boxW,boxH,3,3,'FD');
    doc.setFontSize(15); doc.setFont('helvetica','bold'); doc.setTextColor(box.rt,box.gt,box.bt);
    doc.text(String(box.val), bx+boxW/2, y+12, {align:'center'});
    doc.setFontSize(6.5); doc.setFont('helvetica','normal');
    doc.text(box.label, bx+boxW/2, y+17, {align:'center'});
  });
  y += 28;

  doc.setFillColor(37,99,235); doc.rect(margin,y,W-margin*2,8,'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Fecha', margin+3, y+5.5);
  doc.text('DÃ­a', margin+45, y+5.5);
  doc.text('Estado', W-margin-25, y+5.5, {align:'center'});
  y += 8;

  const diasSemana = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  if (detalle.length === 0) {
    doc.setFontSize(9); doc.setTextColor(150,160,175);
    doc.text('Sin registros en este perÃ­odo', W/2, y+10, {align:'center'});
    y += 20;
  } else {
    detalle.forEach((d,i) => {
      if (i%2===0) { doc.setFillColor(248,250,252); doc.rect(margin,y,W-margin*2,8,'F'); }
      const fechaObj = new Date(d.fecha+'T12:00:00');
      doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(30,41,59);
      doc.text(formatFecha(d.fecha), margin+3, y+5.5);
      doc.text(diasSemana[fechaObj.getDay()], margin+45, y+5.5);
      if (d.estado==='Presente') { doc.setFillColor(220,252,231); doc.setDrawColor(22,163,74); doc.roundedRect(W-margin-38,y+1,32,6,1,1,'FD'); doc.setTextColor(22,163,74); }
      else if (d.estado==='Ausente') { doc.setFillColor(254,226,226); doc.setDrawColor(220,38,38); doc.roundedRect(W-margin-38,y+1,32,6,1,1,'FD'); doc.setTextColor(220,38,38); }
      else { doc.setFillColor(254,243,199); doc.setDrawColor(217,119,6); doc.roundedRect(W-margin-38,y+1,32,6,1,1,'FD'); doc.setTextColor(217,119,6); }
      doc.setFont('helvetica','bold');
      doc.text(d.estado, W-margin-22, y+5.5, {align:'center'});
      y += 8;
      if (y > 268) { doc.addPage(); y = 20; }
    });
  }

  y += 10;
  doc.setDrawColor(180,190,200);
  doc.line(margin,y,margin+60,y); doc.line(W-margin-60,y,W-margin,y);
  doc.setFontSize(8); doc.setTextColor(100,116,139);
  doc.text('Firma Preceptor/a', margin, y+5);
  doc.text('Firma Directora', W-margin-60, y+5);
  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});
  doc.save(`InformeFechas_${alumno.replace(/[^a-zA-Z0-9]/g,'_').substring(0,20)}_${desde}_${hasta}.pdf`);
  showToast('âœ“ Informe generado', 'success');
}

// =============================================
// PLAN PROGRESAR - PRECEPTOR
// =============================================
let progresarSeleccion = {};

function poblarCursosProgresar() {
  const sel = document.getElementById('pro-p-curso');
  sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
  datos.cursos.filter(c => c.preceptor === currentUser.nombre).forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.nombre;
    sel.appendChild(opt);
  });
}

function renderAlumnosProgresar() {
  const cursoId = document.getElementById('pro-p-curso').value;
  if (!cursoId) { document.getElementById('pro-alumnos-wrap').style.display='none'; return; }
  const alumnos = datos.alumnos.filter(a => a.idCurso===cursoId && (a.activo==='SI'||a.activo===true));
  progresarSeleccion = {};
  alumnos.forEach(a => progresarSeleccion[a.nombre] = false);
  document.getElementById('pro-alumnos-list').innerHTML = alumnos.map((a,i) => `
    <div class="alumno-item">
      <div>
        <div class="alumno-name">${a.nombre}</div>
        <div class="alumno-num">DNI: ${a.dni||'â€”'}</div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="pro-chk-${i}"
          onchange="toggleProgresar('${a.nombre.replace(/'/g,"\'")}',this.checked)"
          style="width:20px;height:20px;cursor:pointer;accent-color:#7c3aed">
        <span style="font-size:12px;font-weight:600;color:#7c3aed">Anotado</span>
      </label>
    </div>`).join('');
  document.getElementById('pro-alumnos-wrap').style.display = 'block';
  actualizarContadoresProgresar();
}

function toggleProgresar(nombre, checked) {
  progresarSeleccion[nombre] = checked;
  actualizarContadoresProgresar();
}

function seleccionarTodosProgresar(valor) {
  Object.keys(progresarSeleccion).forEach(n => progresarSeleccion[n] = valor);
  document.querySelectorAll('[id^="pro-chk-"]').forEach(c => c.checked = valor);
  actualizarContadoresProgresar();
}

function actualizarContadoresProgresar() {
  const vals = Object.values(progresarSeleccion);
  document.getElementById('pro-cnt-si').textContent = vals.filter(v=>v).length;
  document.getElementById('pro-cnt-no').textContent = vals.filter(v=>!v).length;
  document.getElementById('pro-cnt-tot').textContent = vals.length;
}

async function guardarYExportarProgresar() {
  const cursoId = document.getElementById('pro-p-curso').value;
  if (!cursoId) { showToast('SeleccionÃ¡ un curso', 'error'); return; }
  const curso = datos.cursos.find(c => c.id === cursoId);
  const anotados = datos.alumnos.filter(a =>
    a.idCurso === cursoId && (a.activo==='SI'||a.activo===true) && progresarSeleccion[a.nombre]
  );

  // Guardar en Sheet
  mostrarGuardando('Guardando en Google Sheets...');
  try {
    const fecha = new Date().toISOString().split('T')[0];
    const rows = anotados.map(a => ({
      fecha, idCurso: cursoId, curso: curso.nombre,
      preceptor: currentUser.nombre, alumno: a.nombre, dni: a.dni||''
    }));
    await fetch(SCRIPT_URL, {
      method:'POST',
      body: JSON.stringify({action:'guardarProgresar', rows})
    });
    showToast('âœ“ Guardado en Google Sheets', 'success');
  } catch(e) {
    showToast('Sin conexiÃ³n, solo se generÃ³ el PDF', '');
  }
  ocultarGuardando();

  if (!anotados.length) { showToast('No hay alumnos seleccionados', 'error'); return; }

  // Generar PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
  const W=210, margin=18;

  doc.setFillColor(124,58,237); doc.rect(0,0,W,46,'F');
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(216,180,254);
  doc.text('CENS â€“ Sistema de GestiÃ³n de Asistencia', margin, 12);
  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Plan Progresar â€“ Alumnos Anotados', margin, 23);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text(`Curso: ${curso.nombre}   Â·   Preceptor/a: ${currentUser.nombre}   Â·   Fecha: ${formatFecha(new Date().toISOString().split('T')[0])}`, margin, 33);

  let y = 52;

  // Cajas
  const boxW=55, boxH=18, gap=10;
  const boxes2 = [
    {label:'ANOTADOS EN PROGRESAR', val:anotados.length, rf:237,gf:233,bf:254,rt:124,gt:58,bt:237},
    {label:'NO ANOTADOS', val:Object.values(progresarSeleccion).filter(v=>!v).length, rf:254,gf:226,bf:226,rt:220,gt:38,bt:38},
    {label:'TOTAL CURSO', val:Object.keys(progresarSeleccion).length, rf:239,gf:246,bf:255,rt:37,gt:99,bt:235},
  ];
  boxes2.forEach((box,i) => {
    const bx = margin+i*(boxW+gap);
    doc.setFillColor(box.rf,box.gf,box.bf); doc.setDrawColor(box.rt,box.gt,box.bt);
    doc.roundedRect(bx,y,boxW,boxH,3,3,'FD');
    doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.setTextColor(box.rt,box.gt,box.bt);
    doc.text(String(box.val), bx+boxW/2, y+11, {align:'center'});
    doc.setFontSize(7); doc.setFont('helvetica','normal');
    doc.text(box.label, bx+boxW/2, y+16, {align:'center'});
  });
  y += 26;

  doc.setFillColor(124,58,237); doc.rect(margin,y,W-margin*2,8,'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('#', margin+3, y+5.5);
  doc.text('Apellido y Nombre', margin+14, y+5.5);
  doc.text('DNI', W-margin-20, y+5.5, {align:'center'});
  y += 8;

  anotados.forEach((a,i) => {
    if (i%2===0) { doc.setFillColor(248,245,255); doc.rect(margin,y,W-margin*2,8,'F'); }
    doc.setFontSize(8); doc.setFont('helvetica','normal');
    doc.setTextColor(100,116,139);
    doc.text(String(i+1).padStart(2,'0'), margin+3, y+5.5);
    doc.setTextColor(30,41,59);
    doc.text(a.nombre, margin+14, y+5.5);
    doc.setTextColor(100,116,139);
    doc.text(a.dni||'â€”', W-margin-20, y+5.5, {align:'center'});
    y += 8;
    if (y > 268) { doc.addPage(); y=20; }
  });

  y += 10;
  doc.setDrawColor(180,190,200);
  doc.line(margin,y,margin+60,y); doc.line(W-margin-60,y,W-margin,y);
  doc.setFontSize(8); doc.setTextColor(100,116,139);
  doc.text('Firma Preceptor/a', margin, y+5);
  doc.text('Sello DirecciÃ³n', W-margin-60, y+5);
  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});

  doc.save(`Progresar_${curso.nombre.replace(/[^a-zA-Z0-9]/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`);
  showToast('âœ“ PDF generado', 'success');
}

// =============================================
// PLAN PROGRESAR - DIRECTORA
// =============================================
let progresarData = [];

async function cargarProgresar() {
  mostrarGuardando('Cargando datos de Progresar...');
  try {
    const res = await fetch(SCRIPT_URL + '?action=getProgresar');
    const json = await res.json();
    if (json.status === 'ok') progresarData = json.registros;
  } catch(e) {}
  ocultarGuardando();
  renderProgreseresDir();
}

function renderProgreseresDir() {
  const el = document.getElementById('pro-resumen-dir');
  if (!progresarData.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“</div><div class="empty-txt">Sin datos de Progresar aÃºn</div></div>';
    return;
  }

  const totalAnotados = progresarData.length;
  const totalAlumnos = datos.alumnos.filter(a => a.activo==='SI'||a.activo===true).length;

  let html = `
    <div class="stats-row">
      <div class="stat-card" style="background:#f5f3ff;border:1px solid #7c3aed">
        <div class="stat-num" style="color:#7c3aed">${totalAnotados}</div>
        <div class="stat-lbl">Total anotados</div>
      </div>
      <div class="stat-card">
        <div class="stat-num">${totalAlumnos}</div>
        <div class="stat-lbl">Total alumnos</div>
      </div>
      <div class="stat-card" style="background:#f5f3ff;border:1px solid #7c3aed">
        <div class="stat-num" style="color:#7c3aed">${totalAlumnos?Math.round(totalAnotados/totalAlumnos*100):0}%</div>
        <div class="stat-lbl">% institucional</div>
      </div>
    </div>`;

  datos.cursos.forEach(c => {
    const anotados = progresarData.filter(r => r.idCurso === c.id);
    const totalCurso = datos.alumnos.filter(a => a.idCurso===c.id && (a.activo==='SI'||a.activo===true)).length;
    const pct = totalCurso ? Math.round(anotados.length/totalCurso*100) : 0;
    html += `
      <div class="card" style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div>
            <div style="font-weight:700;color:var(--text1)">${c.nombre}</div>
            <div style="font-size:12px;color:var(--text2)">${c.preceptor}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:20px;font-weight:800;color:#7c3aed">${anotados.length}</div>
            <div style="font-size:11px;color:var(--text2)">de ${totalCurso} Â· ${pct}%</div>
          </div>
        </div>
        <div style="background:#e5e7eb;border-radius:99px;height:6px">
          <div style="background:#7c3aed;border-radius:99px;height:6px;width:${pct}%"></div>
        </div>
      </div>`;
  });

  el.innerHTML = html;
}

async function generarPDFProgresar() {
  if (!progresarData.length) { showToast('No hay datos de Progresar', 'error'); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
  const W=210, margin=18;

  doc.setFillColor(124,58,237); doc.rect(0,0,W,46,'F');
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(216,180,254);
  doc.text('CENS â€“ Sistema de GestiÃ³n de Asistencia', margin, 12);
  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Seguimiento Plan Progresar', margin, 23);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text(`Informe institucional Â· ${formatFecha(new Date().toISOString().split('T')[0])}`, margin, 33);

  let y = 52;
  const totalAnotados = progresarData.length;
  const totalAlumnos = datos.alumnos.filter(a => a.activo==='SI'||a.activo===true).length;
  const pctInst = totalAlumnos ? Math.round(totalAnotados/totalAlumnos*100) : 0;

  const boxW=55, boxH=18, gap=10;
  const cajas = [
    {label:'TOTAL ANOTADOS', val:totalAnotados, rf:237,gf:233,bf:254,rt:124,gt:58,bt:237},
    {label:'TOTAL ALUMNOS', val:totalAlumnos, rf:239,gf:246,bf:255,rt:37,gt:99,bt:235},
    {label:'% INSTITUCIONAL', val:pctInst+'%', rf:237,gf:233,bf:254,rt:124,gt:58,bt:237},
  ];
  cajas.forEach((box,i) => {
    const bx = margin+i*(boxW+gap);
    doc.setFillColor(box.rf,box.gf,box.bf); doc.setDrawColor(box.rt,box.gt,box.bt);
    doc.roundedRect(bx,y,boxW,boxH,3,3,'FD');
    doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.setTextColor(box.rt,box.gt,box.bt);
    doc.text(String(box.val), bx+boxW/2, y+11, {align:'center'});
    doc.setFontSize(7); doc.setFont('helvetica','normal');
    doc.text(box.label, bx+boxW/2, y+16, {align:'center'});
  });
  y += 26;

  // Tabla por curso
  doc.setFillColor(124,58,237); doc.rect(margin,y,W-margin*2,8,'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Curso', margin+3, y+5.5);
  doc.text('Preceptor/a', margin+60, y+5.5);
  doc.text('Anotados', margin+115, y+5.5, {align:'center'});
  doc.text('Total', margin+135, y+5.5, {align:'center'});
  doc.text('%', W-margin-8, y+5.5, {align:'right'});
  y += 8;

  datos.cursos.forEach((c,i) => {
    if (i%2===0) { doc.setFillColor(248,245,255); doc.rect(margin,y,W-margin*2,8,'F'); }
    const anotados = progresarData.filter(r => r.idCurso===c.id).length;
    const totalCurso = datos.alumnos.filter(a => a.idCurso===c.id && (a.activo==='SI'||a.activo===true)).length;
    const pct = totalCurso ? Math.round(anotados/totalCurso*100) : 0;
    doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(30,41,59);
    doc.text(c.nombre, margin+3, y+5.5);
    doc.text(c.preceptor, margin+60, y+5.5);
    doc.setTextColor(124,58,237); doc.setFont('helvetica','bold');
    doc.text(String(anotados), margin+115, y+5.5, {align:'center'});
    doc.setTextColor(30,41,59); doc.setFont('helvetica','normal');
    doc.text(String(totalCurso), margin+135, y+5.5, {align:'center'});
    doc.setTextColor(pct>0?124:150, pct>0?58:160, pct>0?237:175);
    doc.text(pct+'%', W-margin-8, y+5.5, {align:'right'});
    y += 8;
    if (y > 268) { doc.addPage(); y=20; }
  });

  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});
  doc.save(`Progresar_Institucional_${new Date().toISOString().split('T')[0]}.pdf`);
  showToast('âœ“ PDF generado', 'success');
}

// =============================================
// SALIDA EDUCATIVA
// =============================================
let salidaSeleccion = {};

function poblarCursosSalida() {
  const sel = document.getElementById('sal-curso');
  sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
  datos.cursos.filter(c => c.preceptor === currentUser.nombre).forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.nombre;
    sel.appendChild(opt);
  });
  if (!document.getElementById('sal-fecha').value)
    document.getElementById('sal-fecha').value = new Date().toISOString().split('T')[0];
}

function renderAlumnosSalida() {
  const cursoId = document.getElementById('sal-curso').value;
  if (!cursoId) { document.getElementById('sal-alumnos-wrap').style.display='none'; return; }
  const alumnos = datos.alumnos.filter(a => a.idCurso===cursoId && (a.activo==='SI'||a.activo===true));
  salidaSeleccion = {};
  alumnos.forEach(a => salidaSeleccion[a.nombre] = true);
  document.getElementById('sal-alumnos-list').innerHTML = alumnos.map((a,i) => `
    <div class="alumno-item">
      <div>
        <div class="alumno-name">${a.nombre}</div>
        <div class="alumno-num">DNI: ${a.dni||'â€”'}</div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="sal-chk-${i}" checked
          onchange="toggleSalida('${a.nombre.replace(/'/g,"\'")}',this.checked)"
          style="width:20px;height:20px;cursor:pointer;accent-color:var(--blue)">
        <span style="font-size:12px;font-weight:600;color:var(--green)">Va</span>
      </label>
    </div>`).join('');
  document.getElementById('sal-alumnos-wrap').style.display = 'block';
  actualizarContadoresSalida();
}

function toggleSalida(nombre, checked) { salidaSeleccion[nombre]=checked; actualizarContadoresSalida(); }

function seleccionarTodosSalida(valor) {
  Object.keys(salidaSeleccion).forEach(n => salidaSeleccion[n]=valor);
  document.querySelectorAll('[id^="sal-chk-"]').forEach(c => c.checked=valor);
  actualizarContadoresSalida();
}

function actualizarContadoresSalida() {
  const vals = Object.values(salidaSeleccion);
  document.getElementById('sal-cnt-si').textContent = vals.filter(v=>v).length;
  document.getElementById('sal-cnt-no').textContent = vals.filter(v=>!v).length;
  document.getElementById('sal-cnt-tot').textContent = vals.length;
}

async function generarPDFSalida() {
  const destino = document.getElementById('sal-destino').value.trim();
  const fecha = document.getElementById('sal-fecha').value;
  const cursoId = document.getElementById('sal-curso').value;
  if (!destino) { showToast('EscribÃ­ el nombre o destino de la salida', 'error'); return; }
  if (!fecha) { showToast('SeleccionÃ¡ la fecha', 'error'); return; }
  if (!cursoId) { showToast('SeleccionÃ¡ el curso', 'error'); return; }

  const curso = datos.cursos.find(c => c.id===cursoId);
  const todosAlumnos = datos.alumnos.filter(a => a.idCurso===cursoId && (a.activo==='SI'||a.activo===true));
  const confirmados = todosAlumnos.filter(a => salidaSeleccion[a.nombre]);
  if (!confirmados.length) { showToast('No hay alumnos seleccionados', 'error'); return; }

  // Guardar en Sheet
  mostrarGuardando('Guardando en Google Sheets...');
  try {
    const rows = confirmados.map(a => ({
      fecha, destino, idCurso: cursoId, curso: curso.nombre,
      preceptor: currentUser.nombre, alumno: a.nombre, dni: a.dni||''
    }));
    await fetch(SCRIPT_URL, {
      method:'POST',
      body: JSON.stringify({action:'guardarSalida', rows})
    });
    showToast('âœ“ Guardado en Google Sheets', 'success');
  } catch(e) { showToast('Sin conexiÃ³n, solo se generÃ³ el PDF', ''); }
  ocultarGuardando();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
  const W=210, margin=18;

  doc.setFillColor(37,99,235); doc.rect(0,0,W,50,'F');
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(180,210,255);
  doc.text('CENS â€“ Sistema de GestiÃ³n de Asistencia', margin, 12);
  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Listado de Salida Educativa', margin, 23);
  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text(`Destino: ${destino}`, margin, 32);
  doc.text(`Fecha: ${formatFecha(fecha)}   Â·   Curso: ${curso.nombre}   Â·   Preceptor/a: ${curso.preceptor}`, margin, 40);

  let y = 58;
  const boxW=55, boxH=18, gap=10;
  const boxes3 = [
    {label:'CONFIRMAN ASISTENCIA', val:confirmados.length, rf:220,gf:252,bf:231,rt:22,gt:163,bt:74},
    {label:'NO PARTICIPAN', val:todosAlumnos.length-confirmados.length, rf:254,gf:226,bf:226,rt:220,gt:38,bt:38},
    {label:'TOTAL CURSO', val:todosAlumnos.length, rf:239,gf:246,bf:255,rt:37,gt:99,bt:235},
  ];
  boxes3.forEach((box,i) => {
    const bx = margin+i*(boxW+gap);
    doc.setFillColor(box.rf,box.gf,box.bf); doc.setDrawColor(box.rt,box.gt,box.bt);
    doc.roundedRect(bx,y,boxW,boxH,3,3,'FD');
    doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.setTextColor(box.rt,box.gt,box.bt);
    doc.text(String(box.val), bx+boxW/2, y+11, {align:'center'});
    doc.setFontSize(7); doc.setFont('helvetica','normal');
    doc.text(box.label, bx+boxW/2, y+16, {align:'center'});
  });
  y += 26;

  doc.setFillColor(37,99,235); doc.rect(margin,y,W-margin*2,8,'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('#', margin+3, y+5.5);
  doc.text('Apellido y Nombre', margin+14, y+5.5);
  doc.text('DNI', margin+115, y+5.5, {align:'center'});
  doc.text('Firma', W-margin-15, y+5.5, {align:'center'});
  y += 8;

  confirmados.forEach((a,i) => {
    if (i%2===0) { doc.setFillColor(248,250,252); doc.rect(margin,y,W-margin*2,10,'F'); }
    doc.setFontSize(8); doc.setFont('helvetica','normal');
    doc.setTextColor(100,116,139);
    doc.text(String(i+1).padStart(2,'0'), margin+3, y+6.5);
    doc.setTextColor(30,41,59); doc.text(a.nombre, margin+14, y+6.5);
    doc.setTextColor(100,116,139); doc.text(a.dni||'â€”', margin+115, y+6.5, {align:'center'});
    doc.setDrawColor(200,210,220); doc.line(W-margin-32,y+8,W-margin-4,y+8);
    y += 10;
    if (y > 265) {
      doc.addPage(); y=20;
      doc.setFillColor(37,99,235); doc.rect(margin,y,W-margin*2,8,'F');
      doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
      doc.text('#', margin+3, y+5.5); doc.text('Apellido y Nombre', margin+14, y+5.5);
      doc.text('DNI', margin+115, y+5.5, {align:'center'}); doc.text('Firma', W-margin-15, y+5.5, {align:'center'});
      y += 8;
    }
  });

  y += 10;
  doc.setDrawColor(180,190,200);
  doc.line(margin,y,margin+65,y); doc.line(W-margin-65,y,W-margin,y);
  doc.setFontSize(8); doc.setTextColor(100,116,139);
  doc.text('Firma Preceptor/a', margin, y+5);
  doc.text('Sello y firma DirecciÃ³n', W-margin-65, y+5);
  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});
  doc.save(`Salida_${destino.replace(/[^a-zA-Z0-9]/g,'_').substring(0,20)}_${fecha}.pdf`);
  showToast('âœ“ Listado generado', 'success');
}

// =============================================
// PANEL PROFESOR
// =============================================
async function entrarComoProfesor() {
  mostrarGuardando('Cargando datos...');
  await cargarDatos();
  await cargarRegistrosDesdeSheet();
  ocultarGuardando();
  document.getElementById('screen-app').style.display = 'none';
  document.getElementById('screen-inicio').style.display = 'none';
  document.getElementById('screen-bienvenida').style.display = 'none';
  document.getElementById('view-profesor').style.display = 'block';

  // Poblar todos los selects de cursos
  ['prof-inf-curso','prof-an-curso','prof-fec-curso','prof-res-curso','prof-his-curso'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
    (datos.cursos || []).forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = c.nombre;
      sel.appendChild(opt);
    });
  });

  // Fecha de hoy en historial
  document.getElementById('prof-his-fecha').value = new Date().toISOString().split('T')[0];
  const hoy = new Date().toISOString().split('T')[0];
  document.getElementById('prof-fec-desde').value = hoy.substring(0,7) + '-01';
  document.getElementById('prof-fec-hasta').value = hoy;
}

function profTab(tab, btn) {
  document.querySelectorAll('#view-profesor .tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  ['cuatrimestral','anual','fechas','resumen','historial'].forEach(t => {
    const el = document.getElementById('proftab-' + t);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
}

function poblarCursosProfesor() {
  ['prof-inf-curso', 'prof-an-curso', 'prof-fec-curso'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
    datos.cursos.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = c.nombre;
      sel.appendChild(opt);
    });
  });
  // Poblar alumnos cuando cambia curso en cuatrimestral
  document.getElementById('prof-inf-curso').onchange = () => poblarAlumnosProfesor('inf');
}

function poblarAlumnosProfesor(pre) {
  const cursoId = document.getElementById(`prof-${pre}-curso`).value;
  const sel = document.getElementById(`prof-${pre}-alumno`);
  sel.innerHTML = '<option value="">SeleccionÃ¡ un alumno...</option>';
  if (!cursoId) return;
  datos.alumnos
    .filter(a => a.idCurso === cursoId && (a.activo === 'SI' || a.activo === true))
    .forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.nombre; opt.textContent = a.nombre;
      sel.appendChild(opt);
    });
}

function generarInformeProfesor(tipo) {
  let cursoId, alumno, desde, hasta;

  if (tipo === 'cuatrimestral') {
    cursoId = document.getElementById('prof-inf-curso').value;
    alumno = document.getElementById('prof-inf-alumno').value;
    const periodo = document.getElementById('prof-inf-periodo').value;
    const anio = new Date().getFullYear();
    if (periodo === '1') { desde = `${anio}-03-01`; hasta = `${anio}-06-30`; }
    else if (periodo === '2') { desde = `${anio}-07-01`; hasta = `${anio}-11-30`; }
    else { desde = `${anio}-03-01`; hasta = `${anio}-11-30`; }
  } else if (tipo === 'anual') {
    cursoId = document.getElementById('prof-an-curso').value;
    alumno = document.getElementById('prof-an-alumno').value;
    const anio = new Date().getFullYear();
    desde = `${anio}-01-01`; hasta = `${anio}-12-31`;
  } else {
    cursoId = document.getElementById('prof-fec-curso').value;
    alumno = document.getElementById('prof-fec-alumno').value;
    desde = document.getElementById('prof-fec-desde').value;
    hasta = document.getElementById('prof-fec-hasta').value;
  }

  if (!cursoId) { showToast('SeleccionÃ¡ un curso', 'error'); return; }
  if (!alumno) { showToast('SeleccionÃ¡ un alumno', 'error'); return; }
  if (!desde || !hasta) { showToast('SeleccionÃ¡ las fechas', 'error'); return; }

  const curso = datos.cursos.find(c => c.id === cursoId);
  const regsEnRango = allRegistros
    .filter(r => r.idCurso === cursoId && r.fecha >= desde && r.fecha <= hasta)
    .sort((a,b) => a.fecha.localeCompare(b.fecha));

  let totP=0, totA=0, totT=0, diasConLista=0;
  const detalle = [];
  regsEnRango.forEach(r => {
    const estado = r.data[alumno];
    if (estado !== undefined) {
      diasConLista++;
      if (estado === 'Presente') totP++;
      else if (estado === 'Ausente') totA++;
      else if (estado === 'Tardanza') totT++;
      detalle.push({fecha: r.fecha, estado});
    }
  });
  const pct = diasConLista ? Math.round(totP/diasConLista*100) : 0;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
  const W=210, margin=18;
  const tipoLabel = tipo === 'cuatrimestral' ? 'Informe Cuatrimestral' : tipo === 'anual' ? 'Informe Anual' : 'Informe por Fechas';

  doc.setFillColor(13,148,136); doc.rect(0,0,W,50,'F');
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(167,243,208);
  doc.text('CENS â€“ Sistema de GestiÃ³n de Asistencia', margin, 12);
  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text(tipoLabel, margin, 23);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text(`PerÃ­odo: ${formatFecha(desde)} al ${formatFecha(hasta)}`, margin, 32);
  doc.text(`Alumno/a: ${alumno}   Â·   Curso: ${curso.nombre}   Â·   Preceptor/a: ${curso.preceptor}`, margin, 40);

  let y = 58;
  const boxW=38, boxH=20, gap=7;
  const boxes = [
    {label:'PRESENTES', val:totP, rf:220,gf:252,bf:231,rt:22,gt:163,bt:74},
    {label:'AUSENTES', val:totA, rf:254,gf:226,bf:226,rt:220,gt:38,bt:38},
    {label:'TARDANZAS', val:totT, rf:254,gf:243,bf:199,rt:217,gt:119,bt:6},
    {label:'DÃAS CLASE', val:diasConLista, rf:239,gf:246,bf:255,rt:37,gt:99,bt:235},
    {label:'% ASISTENCIA', val:pct+'%', rf:pct>=75?220:254,gf:pct>=75?252:226,bf:pct>=75?231:226,rt:pct>=75?22:220,gt:pct>=75?163:38,bt:pct>=75?74:38},
  ];
  boxes.forEach((box,i) => {
    const bx = margin+i*(boxW+gap);
    doc.setFillColor(box.rf,box.gf,box.bf); doc.setDrawColor(box.rt,box.gt,box.bt);
    doc.roundedRect(bx,y,boxW,boxH,3,3,'FD');
    doc.setFontSize(15); doc.setFont('helvetica','bold'); doc.setTextColor(box.rt,box.gt,box.bt);
    doc.text(String(box.val), bx+boxW/2, y+12, {align:'center'});
    doc.setFontSize(6.5); doc.setFont('helvetica','normal');
    doc.text(box.label, bx+boxW/2, y+17, {align:'center'});
  });
  y += 28;

  doc.setFillColor(13,148,136); doc.rect(margin,y,W-margin*2,8,'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Fecha', margin+3, y+5.5);
  doc.text('DÃ­a', margin+45, y+5.5);
  doc.text('Estado', W-margin-25, y+5.5, {align:'center'});
  y += 8;

  const diasSemana = ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'];
  if (detalle.length === 0) {
    doc.setFontSize(9); doc.setTextColor(150,160,175);
    doc.text('Sin registros en este perÃ­odo', W/2, y+10, {align:'center'});
    y += 20;
  } else {
    detalle.forEach((d,i) => {
      if (i%2===0) { doc.setFillColor(240,253,250); doc.rect(margin,y,W-margin*2,8,'F'); }
      const fechaObj = new Date(d.fecha+'T12:00:00');
      doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(30,41,59);
      doc.text(formatFecha(d.fecha), margin+3, y+5.5);
      doc.text(diasSemana[fechaObj.getDay()], margin+45, y+5.5);
      if (d.estado==='Presente') { doc.setFillColor(220,252,231); doc.setDrawColor(22,163,74); doc.roundedRect(W-margin-38,y+1,32,6,1,1,'FD'); doc.setTextColor(22,163,74); }
      else if (d.estado==='Ausente') { doc.setFillColor(254,226,226); doc.setDrawColor(220,38,38); doc.roundedRect(W-margin-38,y+1,32,6,1,1,'FD'); doc.setTextColor(220,38,38); }
      else { doc.setFillColor(254,243,199); doc.setDrawColor(217,119,6); doc.roundedRect(W-margin-38,y+1,32,6,1,1,'FD'); doc.setTextColor(217,119,6); }
      doc.setFont('helvetica','bold');
      doc.text(d.estado, W-margin-22, y+5.5, {align:'center'});
      y += 8;
      if (y > 268) { doc.addPage(); y = 20; }
    });
  }

  y += 10;
  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});
  doc.save(`Informe_${tipo}_${alumno.replace(/[^a-zA-Z0-9]/g,'_').substring(0,20)}_${desde}_${hasta}.pdf`);
  showToast('âœ“ Informe generado', 'success');
}

// =============================================
// PROFESOR - RESUMEN CURSO
// =============================================
function poblarCursosResumenProfesor() {
  const sel = document.getElementById('prof-res-curso');
  sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
  datos.cursos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.nombre;
    sel.appendChild(opt);
  });
}

function getRangoProfesor(periodo) {
  const anio = new Date().getFullYear();
  if (periodo === '1') return { desde: `${anio}-03-01`, hasta: `${anio}-06-30` };
  if (periodo === '2') return { desde: `${anio}-07-01`, hasta: `${anio}-11-30` };
  return { desde: `${anio}-03-01`, hasta: `${anio}-11-30` };
}

function renderResumenCursoProfesor() {
  const cursoId = document.getElementById('prof-res-curso').value;
  const periodo = document.getElementById('prof-res-periodo').value;
  const el = document.getElementById('prof-res-lista');
  const btnEl = document.getElementById('prof-res-btn');
  if (!cursoId) { el.innerHTML = ''; btnEl.style.display='none'; return; }

  const { desde, hasta } = getRangoProfesor(periodo);
  const curso = datos.cursos.find(c => c.id === cursoId);
  const alumnos = datos.alumnos.filter(a => a.idCurso === cursoId && (a.activo==='SI'||a.activo===true));
  const regs = allRegistros.filter(r => r.idCurso === cursoId && r.fecha >= desde && r.fecha <= hasta);
  const diasConLista = regs.length;

  if (!diasConLista) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-txt">Sin registros en este perÃ­odo</div></div>';
    btnEl.style.display = 'none';
    return;
  }

  let html = `<div class="card" style="margin-bottom:12px;background:#f0fdfa;border:1px solid #0d9488">
    <div style="font-weight:700;color:#0d9488;margin-bottom:4px">${curso.nombre} Â· ${curso.preceptor}</div>
    <div style="font-size:12px;color:var(--text2)">${diasConLista} dÃ­as con lista tomada</div>
  </div>`;

  html += `<div style="background:#0d9488;border-radius:12px 12px 0 0;padding:8px 14px;display:flex;gap:4px">
    <div style="flex:2;font-size:11px;font-weight:700;color:white">Alumno/a</div>
    <div style="flex:1;font-size:11px;font-weight:700;color:white;text-align:center">P</div>
    <div style="flex:1;font-size:11px;font-weight:700;color:white;text-align:center">A</div>
    <div style="flex:1;font-size:11px;font-weight:700;color:white;text-align:center">T</div>
    <div style="flex:1;font-size:11px;font-weight:700;color:white;text-align:center">%</div>
  </div>`;

  alumnos.forEach((a, i) => {
    let p=0, aus=0, t=0, dias=0;
    regs.forEach(r => {
      const estado = r.data[a.nombre];
      if (estado !== undefined) {
        dias++;
        if (estado==='Presente') p++;
        else if (estado==='Ausente') aus++;
        else if (estado==='Tardanza') t++;
      }
    });
    const pct = dias ? Math.round(p/dias*100) : 0;
    const bg = i%2===0 ? '#f8fafc' : 'white';
    const pctColor = pct >= 75 ? '#16a34a' : '#dc2626';
    html += `<div style="background:${bg};padding:8px 14px;display:flex;gap:4px;border-left:1px solid #e2e8f0;border-right:1px solid #e2e8f0;border-bottom:1px solid #e2e8f0">
      <div style="flex:2;font-size:12px;font-weight:600;color:var(--text1)">${a.nombre}</div>
      <div style="flex:1;font-size:12px;color:#16a34a;font-weight:700;text-align:center">${p}</div>
      <div style="flex:1;font-size:12px;color:#dc2626;font-weight:700;text-align:center">${aus}</div>
      <div style="flex:1;font-size:12px;color:#d97706;font-weight:700;text-align:center">${t}</div>
      <div style="flex:1;font-size:12px;color:${pctColor};font-weight:700;text-align:center">${pct}%</div>
    </div>`;
  });
  html += `<div style="background:#f1f5f9;border-radius:0 0 12px 12px;padding:6px 14px;font-size:10px;color:var(--text2);border:1px solid #e2e8f0;border-top:none">
    P=Presentes Â· A=Ausentes Â· T=Tardanzas Â· %=Asistencia
  </div>`;

  el.innerHTML = html;
  btnEl.style.display = 'block';
}

function generarPDFResumenCurso() {
  const cursoId = document.getElementById('prof-res-curso').value;
  const periodo = document.getElementById('prof-res-periodo').value;
  if (!cursoId) return;

  const { desde, hasta } = getRangoProfesor(periodo);
  const curso = datos.cursos.find(c => c.id === cursoId);
  const alumnos = datos.alumnos.filter(a => a.idCurso===cursoId && (a.activo==='SI'||a.activo===true));
  const regs = allRegistros.filter(r => r.idCurso===cursoId && r.fecha>=desde && r.fecha<=hasta);
  const periodoLabel = periodo==='1'?'1Â° Cuatrimestre':periodo==='2'?'2Â° Cuatrimestre':'Anual';

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
  const W=210, margin=18;

  doc.setFillColor(13,148,136); doc.rect(0,0,W,50,'F');
  doc.setFontSize(9); doc.setFont('helvetica','normal'); doc.setTextColor(167,243,208);
  doc.text('CENS â€“ Sistema de GestiÃ³n de Asistencia', margin, 12);
  doc.setFontSize(18); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Resumen de Asistencia por Curso', margin, 23);
  doc.setFontSize(9); doc.setFont('helvetica','normal');
  doc.text(`${periodoLabel} Â· ${formatFecha(desde)} al ${formatFecha(hasta)}`, margin, 32);
  doc.text(`Curso: ${curso.nombre}   Â·   Preceptor/a: ${curso.preceptor}`, margin, 40);

  let y = 56;
  const colW = [80, 22, 22, 22, 22];
  const colX = [margin, margin+80, margin+102, margin+124, margin+146];

  doc.setFillColor(13,148,136); doc.rect(margin,y,W-margin*2,8,'F');
  doc.setFontSize(8); doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
  doc.text('Apellido y Nombre', colX[0]+2, y+5.5);
  doc.text('Pres.', colX[1]+colW[1]/2, y+5.5, {align:'center'});
  doc.text('Aus.', colX[2]+colW[2]/2, y+5.5, {align:'center'});
  doc.text('Tard.', colX[3]+colW[3]/2, y+5.5, {align:'center'});
  doc.text('%', colX[4]+colW[4]/2, y+5.5, {align:'center'});
  y += 8;

  alumnos.forEach((a, i) => {
    let p=0, aus=0, t=0, dias=0;
    regs.forEach(r => {
      const estado = r.data[a.nombre];
      if (estado!==undefined) { dias++; if(estado==='Presente')p++; else if(estado==='Ausente')aus++; else if(estado==='Tardanza')t++; }
    });
    const pct = dias ? Math.round(p/dias*100) : 0;
    if (i%2===0) { doc.setFillColor(240,253,250); doc.rect(margin,y,W-margin*2,8,'F'); }
    doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(30,41,59);
    doc.text(a.nombre, colX[0]+2, y+5.5);
    doc.setTextColor(22,163,74); doc.setFont('helvetica','bold');
    doc.text(String(p), colX[1]+colW[1]/2, y+5.5, {align:'center'});
    doc.setTextColor(220,38,38);
    doc.text(String(aus), colX[2]+colW[2]/2, y+5.5, {align:'center'});
    doc.setTextColor(217,119,6);
    doc.text(String(t), colX[3]+colW[3]/2, y+5.5, {align:'center'});
    doc.setTextColor(pct>=75?22:220, pct>=75?163:38, pct>=75?74:38);
    doc.text(pct+'%', colX[4]+colW[4]/2, y+5.5, {align:'center'});
    y += 8;
    if (y > 268) { doc.addPage(); y = 20; }
  });

  doc.setFontSize(7); doc.setTextColor(150,160,175);
  doc.text(`Generado el ${new Date().toLocaleString('es-AR')} Â· CENS Asistencia Digital`, W/2, 290, {align:'center'});
  doc.save(`ResumenCurso_${curso.nombre.replace(/[^a-zA-Z0-9]/g,'_')}_${periodoLabel.replace(/ /g,'_')}.pdf`);
  showToast('âœ“ PDF generado', 'success');
}

// =============================================
// PROFESOR - HISTORIAL POR DÃA
// =============================================
function poblarCursosHistorialProfesor() {
  const sel = document.getElementById('prof-his-curso');
  sel.innerHTML = '<option value="">SeleccionÃ¡ un curso...</option>';
  datos.cursos.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.nombre;
    sel.appendChild(opt);
  });
  if (!document.getElementById('prof-his-fecha').value)
    document.getElementById('prof-his-fecha').value = new Date().toISOString().split('T')[0];
}

function renderHistorialDiaProfesor() {
  const cursoId = document.getElementById('prof-his-curso').value;
  const fecha = document.getElementById('prof-his-fecha').value;
  const el = document.getElementById('prof-his-lista');
  if (!cursoId || !fecha) { el.innerHTML = ''; return; }

  const reg = allRegistros.find(r => r.idCurso === cursoId && r.fecha === fecha);
  const curso = datos.cursos.find(c => c.id === cursoId);

  if (!reg) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-txt">Sin lista tomada para este curso y fecha</div></div>`;
    return;
  }

  const alumnos = datos.alumnos.filter(a => a.idCurso===cursoId && (a.activo==='SI'||a.activo===true));
  let p=0, aus=0, t=0;
  alumnos.forEach(a => {
    const e = reg.data[a.nombre];
    if (e==='Presente') p++; else if (e==='Ausente') aus++; else if (e==='Tardanza') t++;
  });

  let html = `<div class="stats-row">
    <div class="stat-card s-green"><div class="stat-num">${p}</div><div class="stat-lbl">Presentes</div></div>
    <div class="stat-card s-red"><div class="stat-num">${aus}</div><div class="stat-lbl">Ausentes</div></div>
    <div class="stat-card"><div class="stat-num">${t}</div><div class="stat-lbl">Tardanzas</div></div>
  </div>
  <div style="background:#0d9488;border-radius:12px 12px 0 0;padding:8px 14px;display:flex;justify-content:space-between">
    <div style="font-size:11px;font-weight:700;color:white">Alumno/a</div>
    <div style="font-size:11px;font-weight:700;color:white">Estado</div>
  </div>`;

  alumnos.forEach((a, i) => {
    const estado = reg.data[a.nombre] || 'â€”';
    const bg = i%2===0 ? '#f8fafc' : 'white';
    let badgeStyle = 'background:#f1f5f9;color:#64748b';
    if (estado==='Presente') badgeStyle = 'background:#dcfce7;color:#16a34a';
    else if (estado==='Ausente') badgeStyle = 'background:#fee2e2;color:#dc2626';
    else if (estado==='Tardanza') badgeStyle = 'background:#fef9c3;color:#d97706';
    html += `<div style="background:${bg};padding:8px 14px;display:flex;justify-content:space-between;align-items:center;border-left:1px solid #e2e8f0;border-right:1px solid #e2e8f0;border-bottom:1px solid #e2e8f0">
      <div style="font-size:12px;font-weight:600;color:var(--text1)">${a.nombre}</div>
      <span style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:99px;${badgeStyle}">${estado}</span>
    </div>`;
  });
  html += `<div style="background:#f1f5f9;border-radius:0 0 12px 12px;padding:6px 14px;font-size:10px;color:var(--text2);border:1px solid #e2e8f0;border-top:none">
    Tomada por: ${reg.preceptor}
  </div>`;

  el.innerHTML = html;
}

// =============================================
// EXPORTAR EXCEL
// =============================================
let salidasData = [];
let progresarExcelData = [];

async function cargarDatosExportar() {
  mostrarGuardando('Cargando datos...');
  try {
    const [resSalidas, resProgresar] = await Promise.all([
      fetch(SCRIPT_URL + '?action=getSalidas'),
      fetch(SCRIPT_URL + '?action=getProgresar')
    ]);
    const jsonSal = await resSalidas.json();
    const jsonPro = await resProgresar.json();
    if (jsonSal.status === 'ok') salidasData = jsonSal.registros || [];
    if (jsonPro.status === 'ok') progresarExcelData = jsonPro.registros || [];
  } catch(e) { showToast('Sin conexiÃ³n', 'error'); }
  ocultarGuardando();
}

function exportarSalidasExcel() {
  if (!salidasData.length) { showToast('PresionÃ¡ primero el tab Exportar para cargar los datos', 'error'); return; }
  const wb = XLSX.utils.book_new();

  // Hoja 1: Detalle por alumno
  const detalleRows = [['ID','Fecha','Destino','Curso','Preceptor/a','Alumno','DNI']];
  salidasData.forEach(r => detalleRows.push([r.id, r.fecha, r.destino, r.curso, r.preceptor, r.alumno, r.dni||'']));
  const ws1 = XLSX.utils.aoa_to_sheet(detalleRows);
  ws1['!cols'] = [{wch:8},{wch:12},{wch:30},{wch:15},{wch:15},{wch:35},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Detalle');

  // Hoja 2: Resumen por salida
  const resumen = {};
  salidasData.forEach(r => {
    const key = `${r.fecha}_${r.destino}_${r.curso}`;
    if (!resumen[key]) resumen[key] = {fecha:r.fecha, destino:r.destino, curso:r.curso, preceptor:r.preceptor, cant:0};
    resumen[key].cant++;
  });
  const resumenRows = [['Fecha','Destino','Curso','Preceptor/a','Alumnos confirmados']];
  Object.values(resumen).forEach(r => resumenRows.push([r.fecha, r.destino, r.curso, r.preceptor, r.cant]));
  const ws2 = XLSX.utils.aoa_to_sheet(resumenRows);
  ws2['!cols'] = [{wch:12},{wch:30},{wch:15},{wch:15},{wch:20}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Resumen por salida');

  XLSX.writeFile(wb, `Salidas_Educativas_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('âœ“ Excel generado', 'success');
}

function exportarProgresarExcel() {
  if (!progresarExcelData.length) { showToast('Sin datos de Progresar', 'error'); return; }
  const wb = XLSX.utils.book_new();

  // Hoja 1: Detalle
  const detalleRows = [['ID','Fecha','Curso','Preceptor/a','Alumno','DNI']];
  progresarExcelData.forEach(r => detalleRows.push([r.id, r.fecha, r.curso, r.preceptor, r.alumno, r.dni||'']));
  const ws1 = XLSX.utils.aoa_to_sheet(detalleRows);
  ws1['!cols'] = [{wch:8},{wch:12},{wch:15},{wch:15},{wch:35},{wch:12}];
  XLSX.utils.book_append_sheet(wb, ws1, 'Detalle');

  // Hoja 2: Resumen por curso
  const resumen = {};
  datos.cursos.forEach(c => resumen[c.id] = {curso:c.nombre, preceptor:c.preceptor, anotados:0, total:0});
  datos.alumnos.filter(a=>a.activo==='SI'||a.activo===true).forEach(a => { if(resumen[a.idCurso]) resumen[a.idCurso].total++; });
  progresarExcelData.forEach(r => { if(resumen[r.idCurso]) resumen[r.idCurso].anotados++; });
  const resumenRows = [['Curso','Preceptor/a','Anotados','Total alumnos','%']];
  Object.values(resumen).forEach(r => resumenRows.push([r.curso, r.preceptor, r.anotados, r.total, r.total?Math.round(r.anotados/r.total*100)+'%':'0%']));
  const ws2 = XLSX.utils.aoa_to_sheet(resumenRows);
  ws2['!cols'] = [{wch:15},{wch:15},{wch:10},{wch:15},{wch:8}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Resumen por curso');

  XLSX.writeFile(wb, `Plan_Progresar_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('âœ“ Excel generado', 'success');
}

function exportarAsistenciaExcel() {
  if (!allRegistros.length) { showToast('Sin datos de asistencia', 'error'); return; }
  const wb = XLSX.utils.book_new();

  // Una hoja por curso
  datos.cursos.forEach(c => {
    const regs = allRegistros.filter(r => r.idCurso === c.id).sort((a,b) => a.fecha.localeCompare(b.fecha));
    if (!regs.length) return;
    const alumnos = datos.alumnos.filter(a => a.idCurso===c.id && (a.activo==='SI'||a.activo===true));
    const fechas = regs.map(r => r.fecha);
    const header = ['Alumno/a', ...fechas];
    const rows = [header];
    alumnos.forEach(a => {
      const row = [a.nombre];
      fechas.forEach(f => {
        const reg = regs.find(r => r.fecha === f);
        row.push(reg ? (reg.data[a.nombre] || 'â€”') : 'â€”');
      });
      rows.push(row);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [{wch:35}, ...fechas.map(() => ({wch:12}))];
    XLSX.utils.book_append_sheet(wb, ws, c.nombre.substring(0,31));
  });

  XLSX.writeFile(wb, `Asistencia_Completa_${new Date().toISOString().split('T')[0]}.xlsx`);
  showToast('âœ“ Excel generado', 'success');
}
</script>
</body>
</html>
